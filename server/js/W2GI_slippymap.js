OpenLayers.Map.prototype.zoomTo=function(a){if(this.isValidZoomLevel(a))if(0<this.popups.length){var c=this.popups[0];this.setCenter(c.lonlat,a);this.adjustForBubble(c.lonlat,c.bubbleSize,c.bubbleMargin,c.bubbleOffset)}else this.setCenter(null,a)};OpenLayers.Map.prototype.removePopups=function(){this.popups.each(function(a){this.removePopup(a)}.bind(this))};
OpenLayers.Map.prototype.adjustForBubble=function(a,c,b,d){a=this.getPixelFromLonLat(a);c=new OpenLayers.Bounds(a.x+d.x-b.left,a.y+b.bottom,a.x+d.x+c.w+b.right,a.y+d.y-b.top);b=this.getExtent();b=this.getPixelFromLonLat(new OpenLayers.LonLat(b.right,b.bottom));b=new OpenLayers.Bounds(0,b.y,b.x,0);d=0;c.left<b.left?d=b.left-c.left:c.right>b.right&&(d=b.right-c.right);a=0;c.bottom>b.bottom?a=b.bottom-c.bottom:c.top<b.top&&(a=b.top-c.top);0==d&&0==a||(1E3<Math.abs(d)||1E3<Math.abs(a)?(c=c.getCenterPixel(),
c=this.getLonLatFromPixel(c),this.setCenter(c)):this.pan(-d,-a))};
OpenLayers.Map.prototype.setBaseLayer=function(a){if(a!=this.baseLayer&&-1!=OpenLayers.Util.indexOf(this.layers,a)){var c=this.getCachedCenter();c&&(a&&this.baseLayer&&a.projection.toString()!=this.baseLayer.projection.toString())&&c.transform(this.baseLayer.projection,a.projection);var b=OpenLayers.Util.getResolutionFromScale(this.getScale(),a.units);null!=this.baseLayer&&!this.allOverlays&&this.baseLayer.setVisibility(!1);this.baseLayer=a;if(!this.allOverlays||this.baseLayer.visibility)this.baseLayer.setVisibility(!0),
!1===this.baseLayer.inRange&&this.baseLayer.redraw();null!=c&&(a=this.getZoomForResolution(b||this.resolution,!0),this.setCenter(c,a,!1,!0));this.events.triggerEvent("changebaselayer",{layer:this.baseLayer})}};
OpenLayers.Layer.Markers.prototype.addMarker=function(a){"EPSG:900913"==this.map.baseLayer.projection.toString()&&(180>a.lonlat.lon&&-180<a.lonlat.lon&&90>a.lonlat.lat&&-90<a.lonlat.lat)&&a.lonlat.transform(new OpenLayers.Projection("EPSG:4326"),this.map.baseLayer.projection);this.markers.push(a);null!=this.opacity&&a.setOpacity(this.opacity);this.map&&this.map.getExtent()&&(a.map=this.map,this.drawMarker(a))};
OpenLayers.Layer.Markers.prototype.setZIndex=function(a){this.div.style.zIndex=724>a?724+(25*(a/725)).round():749};
OpenLayers.Popup=OpenLayers.Class({events:null,id:"",lonlat:null,div:null,size:null,contentHTML:"",backgroundColor:"",opacity:"",border:"",contentDiv:null,padding:5,map:null,initialize:function(a,c,b,d,e){null==a&&(a=OpenLayers.Util.createUniqueID(this.CLASS_NAME+"_"));this.id=a;this.lonlat=c;this.size=null!=b?b:new OpenLayers.Size(OpenLayers.Popup.WIDTH,OpenLayers.Popup.HEIGHT);null!=d&&(this.contentHTML=d);this.backgroundColor=OpenLayers.Popup.COLOR;this.opacity=OpenLayers.Popup.OPACITY;this.border=
OpenLayers.Popup.BORDER;this.div=OpenLayers.Util.createDiv(this.id,null,null,null,null,null,"");this.div.className="olPopup";a=this.div.id+"_contentDiv";this.contentDiv=OpenLayers.Util.createDiv(a,null,this.size.clone(),null,"relative",null,"");this.contentDiv.className="olPopupContent";this.div.appendChild(this.contentDiv);!0==e&&(a=new OpenLayers.Size(17,17),c=OpenLayers.Util.getImagesLocation()+"close.gif",a=OpenLayers.Util.createAlphaImageDiv(this.id+"_close",null,a,c),a.style.right=this.padding+
"px",a.style.top=this.padding+"px",this.div.appendChild(a),OpenLayers.Event.observe(a,"click",function(a){this.hide();OpenLayers.Event.stop(a)}.bindAsEventListener(this)));this.registerEvents()},destroy:function(){null!=this.map&&(this.map.removePopup(this),this.map=null);this.events.destroy();this.div=this.events=null},draw:function(a){null==a&&null!=this.lonlat&&null!=this.map&&(a=this.map.getLayerPxFromLonLat(this.lonlat));this.setContentHTML();this.moveTo(a);return this.div},updatePosition:function(){if(this.lonlat&&
this.map){var a=this.map.getLayerPxFromLonLat(this.lonlat);this.moveTo(a)}},moveTo:function(a){null!=a&&null!=this.div&&(this.div.style.left=a.x+"px",this.div.style.top=a.y+"px")},visible:function(){return OpenLayers.Element.visible(this.div)},toggle:function(){OpenLayers.Element.toggle(this.div)},show:function(){OpenLayers.Element.show(this.div)},hide:function(){document.fire("w2gi:popupclose",{data:this})},setSize:function(a){void 0!=a&&(this.size=a);null!=this.div&&(this.div.style.width=this.size.w+
"px",this.div.style.height=this.size.h+"px");null!=this.contentDiv&&(this.contentDiv.style.width=this.size.w+"px",this.contentDiv.style.height=this.size.h+"px")},setBackgroundColor:function(a){void 0!=a&&(this.backgroundColor=a);null!=this.div&&(this.div.style.backgroundColor=this.backgroundColor)},setOpacity:function(a){void 0!=a&&(this.opacity=a);null!=this.div&&(this.div.style.opacity=this.opacity,this.div.style.filter="alpha(opacity="+100*this.opacity+")")},setBorder:function(a){void 0!=a&&(this.border=
a);null!=this.div&&(this.div.style.border=this.border)},setContentHTML:function(a){null!=a&&(this.contentHTML=a);null!=this.contentDiv&&(this.contentDiv.innerHTML=this.contentHTML)},registerEvents:function(){this.events=new OpenLayers.Events(this,this.div,null,!0);this.events.register("mousedown",this,this.onmousedown);this.events.register("mousemove",this,this.onmousemove);this.events.register("mouseup",this,this.onmouseup);this.events.register("click",this,this.onclick);this.events.register("mouseout",
this,this.onmouseout);this.events.register("dblclick",this,this.ondblclick)},onmousedown:function(a){this.mousedown=!0;OpenLayers.Event.stop(a,!0)},onmousemove:function(a){this.mousedown&&OpenLayers.Event.stop(a,!0)},onmouseup:function(a){this.mousedown&&(this.mousedown=!1,OpenLayers.Event.stop(a,!0))},onclick:function(a){OpenLayers.Event.stop(a,!0)},onmouseout:function(){this.mousedown=!1},ondblclick:function(a){OpenLayers.Event.stop(a,!0)},CLASS_NAME:"OpenLayers.Popup"});
OpenLayers.Popup.WIDTH=200;OpenLayers.Popup.HEIGHT=200;OpenLayers.Popup.COLOR="white";OpenLayers.Popup.OPACITY=1;OpenLayers.Popup.BORDER="0px";
OpenLayers.Popup.Anchored=OpenLayers.Class(OpenLayers.Popup,{relativePosition:null,anchor:null,initialize:function(a,c,b,d,e,f){OpenLayers.Popup.prototype.initialize.apply(this,[a,c,b,d,f]);this.anchor=null!=e?e:{size:new OpenLayers.Size(0,0),offset:new OpenLayers.Pixel(0,0)}},draw:function(a){null==a&&null!=this.lonlat&&null!=this.map&&(a=this.map.getLayerPxFromLonLat(this.lonlat));this.relativePosition=this.calculateRelativePosition(a);return OpenLayers.Popup.prototype.draw.apply(this,arguments)},
calculateRelativePosition:function(a){a=this.map.getLonLatFromLayerPx(a);a=this.map.getExtent().determineQuadrant(a);return OpenLayers.Bounds.oppositeQuadrant(a)},moveTo:function(a){a=a.offset(this.anchor.bubbleOffset);OpenLayers.Popup.prototype.moveTo.apply(this,Array(a))},setSize:function(a){OpenLayers.Popup.prototype.setSize.apply(this,arguments);if(this.lonlat&&this.map){var c=this.map.getLayerPxFromLonLat(this.lonlat);this.moveTo(c)}},calculateNewPx:function(a){var a=a.offset(this.anchor.offset),
c="t"==this.relativePosition.charAt(0);a.y+=c?-this.size.h:this.anchor.size.h;c="l"==this.relativePosition.charAt(1);a.x+=c?-this.size.w:this.anchor.size.w;return a},CLASS_NAME:"OpenLayers.Popup.Anchored"});
OpenLayers.Popup.AnchoredBubble=OpenLayers.Class(OpenLayers.Popup.Anchored,{rounded:!1,initialize:function(a,c,b,d,e,f){OpenLayers.Popup.Anchored.prototype.initialize.apply(this,arguments)},draw:function(a){OpenLayers.Popup.Anchored.prototype.draw.apply(this,arguments);this.setContentHTML();document.fire("w2gi:popupopen",{data:this});return this.div},setSize:function(a){OpenLayers.Popup.Anchored.prototype.setSize.apply(this,arguments);if(null!=this.contentDiv){var c=this.size.clone();this.contentDiv.style.height=
c.h+"px";this.contentDiv.style.width=c.w+"px"}},setBackgroundColor:function(a){void 0!=a&&(this.backgroundColor=a);null!=this.div&&null!=this.contentDiv&&(this.div.style.background="transparent")},setOpacity:function(a){void 0!=a&&(this.opacity=a);null!=this.div&&null!=this.contentDiv&&OpenLayers.Rico.Corner.changeOpacity(this.contentDiv,this.opacity)},setBorder:function(){this.border=0},CLASS_NAME:"OpenLayers.Popup.AnchoredBubble"});OpenLayers.Popup.AnchoredBubble.CORNER_SIZE=5;
OpenLayers.Feature.prototype.popupClass=OpenLayers.Popup.AnchoredBubble;Prototype.Browser.IE6=Prototype.Browser.IE&&6==parseInt(navigator.userAgent.substring(navigator.userAgent.indexOf("MSIE")+5));
Prototype.Browser.IE6&&(OpenLayers.Util.onImageLoadError=function(){this._attempts=this._attempts?this._attempts+1:1;this._attempts<=OpenLayers.IMAGE_RELOAD_ATTEMPTS?(src=this.src,this.src=src=-1==src.indexOf("&ra=")?src+"&ra="+(Math.floor(90*Math.random())+10):src.replace(/\&ra=../,"&ra="+(Math.floor(90*Math.random())+10))):this.style.backgroundColor=OpenLayers.Util.onImageLoadErrorColor;this.style.display=""},OpenLayers.Util.createAlphaImageDiv=function(a,c,b,d,e,f,j,h,k){var g=OpenLayers.Util.createDiv(),
l=OpenLayers.Util.createImage(null,null,null,null,null,null,null,!1);g.appendChild(l);g.unselectable="on";k&&(l.style.display="none",OpenLayers.Event.observe(l,"load",OpenLayers.Function.bind(OpenLayers.Util.onImageLoad,g)),OpenLayers.Event.observe(l,"error",OpenLayers.Function.bind(OpenLayers.Util.onImageLoadError,g)));OpenLayers.Util.modifyAlphaImageDiv(g,a,c,b,d,e,f,j,h);return g});
ace.util.numberFormat&&(OpenLayers.LonLat.prototype.toShortString=function(){return this.lon.toString().replace(",",".")+", "+this.lat.toString().replace(",",".")});OpenLayers.LonLat.prototype.projCode="";OpenLayers.LonLat.prototype.initialize=function(a,c){this.lon=parseFloat(a);this.lat=parseFloat(c);this.projCode=(new OpenLayers.Bounds(-180,-90,180,90)).containsLonLat(this)?"EPSG:4326":"EPSG:900913"};
OpenLayers.LonLat.prototype.transform=function(a,c){if(this.projCode!=c.projCode){var b=OpenLayers.Projection.transform({x:this.lon,y:this.lat},a,c);this.lon=b.x;this.lat=b.y}return this};OpenLayers.Bounds.prototype.projCode="";
OpenLayers.Bounds.prototype.initialize=function(a,c,b,d,e){null!=a&&(this.left=parseFloat(a));null!=c&&(this.bottom=parseFloat(c));null!=b&&(this.right=parseFloat(b));null!=d&&(this.top=parseFloat(d));e||(a=new OpenLayers.Bounds(-180,-90,180,90,!0),this.projCode=this.intersectsBounds(a)?"EPSG:4326":"EPSG:900913")};
OpenLayers.Bounds.prototype.transform=function(a,c){if(this.projCode!=c.projCode){var b=OpenLayers.Projection.transform({x:this.left,y:this.bottom},a,c),d=OpenLayers.Projection.transform({x:this.right,y:this.bottom},a,c),e=OpenLayers.Projection.transform({x:this.left,y:this.top},a,c),f=OpenLayers.Projection.transform({x:this.right,y:this.top},a,c);this.left=Math.min(b.x,e.x);this.bottom=Math.min(b.y,d.y);this.right=Math.max(d.x,f.x);this.top=Math.max(e.y,f.y)}return this};
OpenLayers.Geometry.Point.prototype.projCode="";OpenLayers.Geometry.Point.prototype.initialize=function(a,c){OpenLayers.Geometry.prototype.initialize.apply(this,arguments);this.x=parseFloat(a);this.y=parseFloat(c);a&&c&&(this.projCode=-180<=this.x&&180>=this.x&&-90<=this.y&&90>=this.y?"EPSG:4326":"EPSG:900913")};OpenLayers.Geometry.Point.prototype.transform=function(a,c){this.projCode!=c.projCode&&(a&&c)&&(OpenLayers.Projection.transform(this,a,c),this.projCode=c.projCode);return this};
OpenLayers.Handler.Click=OpenLayers.Class(OpenLayers.Handler,{delay:300,single:!0,"double":!1,pixelTolerance:0,stopSingle:!1,stopDouble:!1,timerId:null,down:null,initialize:function(a,c,b){OpenLayers.Handler.prototype.initialize.apply(this,arguments);null!=this.pixelTolerance&&(this.mousedown=function(a){this.down=a.xy;return!0})},mousedown:null,dblclick:function(a){this.passesTolerance(a)&&(this["double"]&&(this.callback("dblclick",[a]),document.fire("w2gi:track",{action:"mapzoom",value:1})),this.clearTimer());
return!this.stopDouble},click:function(a){this.passesTolerance(a)&&(null!=this.timerId?this.clearTimer():(a=this.single?OpenLayers.Util.extend({},a):null,this.timerId=window.setTimeout(OpenLayers.Function.bind(this.delayedCall,this,a),this.delay)));return!this.stopSingle},passesTolerance:function(a){var c=!0;null!=this.pixelTolerance&&this.down&&Math.sqrt(Math.pow(this.down.x-a.xy.x,2)+Math.pow(this.down.y-a.xy.y,2))>this.pixelTolerance&&(c=!1);return c},clearTimer:function(){null!=this.timerId&&
(window.clearTimeout(this.timerId),this.timerId=null)},delayedCall:function(a){this.timerId=null;a&&this.callback("click",[a])},deactivate:function(){var a=!1;OpenLayers.Handler.prototype.deactivate.apply(this,arguments)&&(this.clearTimer(),this.down=null,a=!0);return a},CLASS_NAME:"OpenLayers.Handler.Click"});
OpenLayers.Handler.MouseWheel=OpenLayers.Class(OpenLayers.Handler,{wheelListener:null,mousePosition:null,initialize:function(a,c,b){OpenLayers.Handler.prototype.initialize.apply(this,arguments);this.wheelListener=OpenLayers.Function.bindAsEventListener(this.onWheelEvent,this)},destroy:function(){OpenLayers.Handler.prototype.destroy.apply(this,arguments);this.wheelListener=null},onWheelEvent:function(a){if(this.map&&this.checkModifiers(a)){for(var c=!1,b=!1,d=!1,e=OpenLayers.Event.element(a);null!=
e&&!d&&!c;){if(!c)try{var f=e.currentStyle?e.currentStyle.overflow:document.defaultView.getComputedStyle(e,null).getPropertyValue("overflow"),c=f&&"auto"==f||"scroll"==f}catch(j){}if(!b)for(d=0;d<this.map.layers.length;d++)if(e==this.map.layers[d].div||e==this.map.layers[d].pane){b=!0;break}d=e==this.map.div;e=e.parentNode}!c&&d&&(b&&this.wheelZoom(a),OpenLayers.Event.stop(a))}},wheelZoom:function(a){document.fire("w2gi:track",{action:"mapzoom",value:1});var c=0;a||(a=window.event);a.wheelDelta?(c=
a.wheelDelta/120,window.opera&&9.2>window.opera.version()&&(c=-c)):a.detail&&(c=-a.detail/3);c&&(this.mousePosition&&(a.xy=this.mousePosition),a.xy||(a.xy=this.map.getPixelFromLonLat(this.map.getCenter())),0>c?this.callback("down",[a,c]):this.callback("up",[a,c]))},mousemove:function(a){this.mousePosition=a.xy},activate:function(a){if(OpenLayers.Handler.prototype.activate.apply(this,arguments)){var c=this.wheelListener;OpenLayers.Event.observe(window,"DOMMouseScroll",c);OpenLayers.Event.observe(window,
"mousewheel",c);OpenLayers.Event.observe(document,"mousewheel",c);return!0}return!1},deactivate:function(a){if(OpenLayers.Handler.prototype.deactivate.apply(this,arguments)){var c=this.wheelListener;OpenLayers.Event.stopObserving(window,"DOMMouseScroll",c);OpenLayers.Event.stopObserving(window,"mousewheel",c);OpenLayers.Event.stopObserving(document,"mousewheel",c);return!0}return!1},CLASS_NAME:"OpenLayers.Handler.MouseWheel"});
OpenLayers.Handler.Drag=OpenLayers.Class(OpenLayers.Handler,{started:!1,stopDown:!0,dragging:!1,last:null,start:null,oldOnselectstart:null,initialize:function(a,c,b){OpenLayers.Handler.prototype.initialize.apply(this,arguments)},down:function(){},move:function(){},up:function(){},out:function(){},mousedown:function(a){var c=!0;this.dragging=!1;this.checkModifiers(a)&&OpenLayers.Event.isLeftClick(a)?(this.started=!0,this.last=this.start=a.xy,this.map.div.style.cursor="move",this.down(a),this.callback("down",
[a.xy]),OpenLayers.Event.stop(a),this.oldOnselectstart||(this.oldOnselectstart=document.onselectstart?document.onselectstart:function(){return!0},document.onselectstart=function(){return!1}),c=!this.stopDown):(this.started=!1,this.last=this.start=null);return c},mousemove:function(a){if(this.started&&(a.xy.x!=this.last.x||a.xy.y!=this.last.y))this.dragging=!0,this.move(a),this.callback("move",[a.xy]),this.oldOnselectstart||(this.oldOnselectstart=document.onselectstart,document.onselectstart=function(){return!1}),
this.last=a.xy;return!0},mouseup:function(a){if(this.started){var c=this.start!=this.last;this.dragging=this.started=!1;this.map.div.style.cursor="";this.up(a);this.callback("up",[a.xy]);c&&(this.callback("done",[a.xy]),document.fire("w2gi:track",{action:"mappan",value:a.xy.x+","+a.xy.y}));document.onselectstart=this.oldOnselectstart}return!0},mouseout:function(a){if(this.started&&OpenLayers.Util.mouseLeft(a,this.map.div)){var c=this.start!=this.last;this.dragging=this.started=!1;this.map.div.style.cursor=
"";this.out(a);this.callback("out",[]);c&&this.callback("done",[a.xy]);document.onselectstart&&(document.onselectstart=this.oldOnselectstart)}return!0},click:function(){return this.start==this.last},activate:function(){var a=!1;OpenLayers.Handler.prototype.activate.apply(this,arguments)&&(this.dragging=!1,a=!0);return a},deactivate:function(){var a=!1;OpenLayers.Handler.prototype.deactivate.apply(this,arguments)&&(this.dragging=this.started=!1,this.last=this.start=null,a=!0);return a},CLASS_NAME:"OpenLayers.Handler.Drag"});
OpenLayers.Control.PanZoom=OpenLayers.Class(OpenLayers.Control,{slideFactor:50,buttons:null,position:null,initialize:function(a){this.position=new OpenLayers.Pixel(OpenLayers.Control.PanZoom.X,OpenLayers.Control.PanZoom.Y);OpenLayers.Control.prototype.initialize.apply(this,arguments)},destroy:function(){for(OpenLayers.Control.prototype.destroy.apply(this,arguments);this.buttons.length;){var a=this.buttons.shift();a.map=null;OpenLayers.Event.stopObservingElement(a)}this.position=this.buttons=null},
draw:function(a){OpenLayers.Control.prototype.draw.apply(this,arguments);a=this.position;this.buttons=[];var c=new OpenLayers.Size(18,18),b=new OpenLayers.Pixel(a.x+c.w/2,a.y);this._addButton("panup","north-mini.png",b,c);a.y=b.y+c.h;this._addButton("panleft","west-mini.png",a,c);this._addButton("panright","east-mini.png",a.add(c.w,0),c);this._addButton("pandown","south-mini.png",b.add(0,2*c.h),c);this._addButton("zoomin","zoom-plus-mini.png",b.add(0,3*c.h+5),c);this._addButton("zoomworld","zoom-world-mini.png",
b.add(0,4*c.h+5),c);this._addButton("zoomout","zoom-minus-mini.png",b.add(0,5*c.h+5),c);return this.div},_addButton:function(a,c,b,d){c=OpenLayers.Util.getImagesLocation()+c;b=OpenLayers.Util.createAlphaImageDiv("OpenLayers_Control_PanZoom_"+a,b,d,c,"absolute");this.div.appendChild(b);OpenLayers.Event.observe(b,"mousedown",OpenLayers.Function.bindAsEventListener(this.buttonDown,b));OpenLayers.Event.observe(b,"dblclick",OpenLayers.Function.bindAsEventListener(this.doubleClick,b));OpenLayers.Event.observe(b,
"click",OpenLayers.Function.bindAsEventListener(this.doubleClick,b));b.action=a;b.map=this.map;b.slideFactor=this.slideFactor;this.buttons.push(b);return b},doubleClick:function(a){OpenLayers.Event.stop(a);return!1},buttonDown:function(a){if(OpenLayers.Event.isLeftClick(a)){switch(this.action){case "panup":this.map.pan(0,-this.slideFactor);document.fire("w2gi:track",{action:"mappan",value:-this.slideFactor});break;case "pandown":this.map.pan(0,this.slideFactor);document.fire("w2gi:track",{action:"mappan",
value:this.slideFactor});break;case "panleft":this.map.pan(-this.slideFactor,0);document.fire("w2gi:track",{action:"mappan",value:-this.slideFactor});break;case "panright":this.map.pan(this.slideFactor,0);document.fire("w2gi:track",{action:"mappan",value:this.slideFactor});break;case "zoomin":this.map.zoomIn();document.fire("w2gi:track",{action:"mapzoom",value:1});break;case "zoomout":this.map.zoomOut();document.fire("w2gi:track",{action:"mapzoom",value:1});break;case "zoomworld":this.map.zoomToMaxExtent(),
document.fire("w2gi:track",{action:"mapzoom",value:1})}OpenLayers.Event.stop(a)}},CLASS_NAME:"OpenLayers.Control.PanZoom"});OpenLayers.Control.PanZoom.X=4;OpenLayers.Control.PanZoom.Y=4;
OpenLayers.Control.PanZoomBar=OpenLayers.Class(OpenLayers.Control.PanZoom,{zoomStopWidth:18,zoomStopHeight:11,slider:null,sliderEvents:null,zoomBarDiv:null,divEvents:null,zoomWorldIcon:!1,initialize:function(){OpenLayers.Control.PanZoom.prototype.initialize.apply(this,arguments)},destroy:function(){this.div.removeChild(this.slider);this.slider=null;this.sliderEvents.destroy();this.sliderEvents=null;this.div.removeChild(this.zoombarDiv);this.zoomBarDiv=null;this.divEvents.destroy();this.divEvents=
null;this.map.events.un({zoomend:this.moveZoomBar,changebaselayer:this.redraw,scope:this});OpenLayers.Control.PanZoom.prototype.destroy.apply(this,arguments)},setMap:function(a){OpenLayers.Control.PanZoom.prototype.setMap.apply(this,arguments);this.map.events.register("changebaselayer",this,this.redraw)},redraw:function(){null!=this.div&&(this.div.innerHTML="");this.draw()},draw:function(a){OpenLayers.Control.prototype.draw.apply(this,arguments);a=this.position.clone();this.buttons=[];var c=new OpenLayers.Size(18,
18),b=new OpenLayers.Pixel(a.x+c.w/2,a.y),d=c.w;this.zoomWorldIcon&&(b=new OpenLayers.Pixel(a.x+c.w,a.y));this._addButton("panup","north-mini.png",b,c);a.y=b.y+c.h;this._addButton("panleft","west-mini.png",a,c);this.zoomWorldIcon&&(this._addButton("zoomworld","zoom-world-mini.png",a.add(c.w,0),c),d*=2);this._addButton("panright","east-mini.png",a.add(d,0),c);this._addButton("pandown","south-mini.png",b.add(0,2*c.h),c);this._addButton("zoomin","zoom-plus-mini.png",b.add(0,3*c.h+5),c);b=this._addZoomBar(b.add(0,
4*c.h+5));this._addButton("zoomout","zoom-minus-mini.png",b,c);return this.div},_addZoomBar:function(a){var c=OpenLayers.Util.getImagesLocation(),b="OpenLayers_Control_PanZoomBar_Slider"+this.map.id,d=this.map.getNumZoomLevels(),e=d-this.map.getZoom();this.slider=e=OpenLayers.Util.createAlphaImageDiv(b,a.add(-1,e*this.zoomStopHeight),new OpenLayers.Size(20,9),c+"slider.png","absolute");this.sliderEvents=new OpenLayers.Events(this,e,null,!0,{includeXY:!0});this.sliderEvents.on({mousedown:this.zoomBarDown,
mousemove:this.zoomBarDrag,mouseup:this.zoomBarUp,dblclick:this.doubleClick,click:this.doubleClick});var f=new OpenLayers.Size;f.h=this.zoomStopHeight*d;f.w=this.zoomStopWidth;b=null;OpenLayers.Util.alphaHack()?(b="OpenLayers_Control_PanZoomBar"+this.map.id,b=OpenLayers.Util.createAlphaImageDiv(b,a,new OpenLayers.Size(f.w,this.zoomStopHeight),c+"zoombar.png","absolute",null,"crop"),b.style.height=f.h):b=OpenLayers.Util.createDiv("OpenLayers_Control_PanZoomBar_Zoombar"+this.map.id,a,f,c+"zoombar.png");
this.zoombarDiv=b;this.divEvents=new OpenLayers.Events(this,b,null,!0);this.divEvents.on({mousedown:this.divClick,mousemove:this.passEventToSlider,dblclick:this.doubleClick,click:this.doubleClick});this.div.appendChild(b);this.startTop=parseInt(b.style.top);this.div.appendChild(e);this.map.events.register("zoomend",this,this.moveZoomBar);return a=a.add(0,this.zoomStopHeight*d)},passEventToSlider:function(a){this.sliderEvents.handleBrowserEvent(a)},divClick:function(a){if(OpenLayers.Event.isLeftClick(a)){var c=
a.clientY?a.clientY:a.y,b=OpenLayers.Util.pagePosition(a.currentTarget?a.currentTarget:a.srcElement)[1],c=(c-b)/this.zoomStopHeight;this.map.fractionalZoom||(c=Math.floor(c));c=this.map.getNumZoomLevels()-1-c;c=Math.min(Math.max(c,0),this.map.getNumZoomLevels()-1);this.map.zoomTo(c);OpenLayers.Event.stop(a)}},zoomBarDown:function(a){OpenLayers.Event.isLeftClick(a)&&(this.map.events.on({mousemove:this.passEventToSlider,mouseup:this.passEventToSlider,scope:this}),this.mouseDragStart=a.xy.clone(),this.zoomStart=
a.xy.clone(),this.div.style.cursor="move",this.zoombarDiv.offsets=null,OpenLayers.Event.stop(a))},zoomBarDrag:function(a){if(null!=this.mouseDragStart){var c=this.mouseDragStart.y-a.xy.y,b=OpenLayers.Util.pagePosition(this.zoombarDiv);0<a.clientY-b[1]&&a.clientY-b[1]<parseInt(this.zoombarDiv.style.height)-2&&(c=parseInt(this.slider.style.top)-c,this.slider.style.top=c+"px");this.mouseDragStart=a.xy.clone();OpenLayers.Event.stop(a)}},zoomBarUp:function(a){if(OpenLayers.Event.isLeftClick(a)&&this.zoomStart){this.div.style.cursor=
"";this.map.events.un({mouseup:this.passEventToSlider,mousemove:this.passEventToSlider,scope:this});var c=this.zoomStart.y-a.xy.y,b=this.map.zoom;this.map.fractionalZoom?(b+=c/this.zoomStopHeight,b=Math.min(Math.max(b,0),this.map.getNumZoomLevels()-1)):b+=Math.round(c/this.zoomStopHeight);document.fire("w2gi:track",{action:"mapzoom",value:b});this.map.zoomTo(b);this.moveZoomBar();this.mouseDragStart=null;OpenLayers.Event.stop(a)}},moveZoomBar:function(){var a=(this.map.getNumZoomLevels()-1-this.map.getZoom())*
this.zoomStopHeight+this.startTop+1;this.slider.style.top=a+"px"},CLASS_NAME:"OpenLayers.Control.PanZoomBar"});
OpenLayers.Control.LayerSwitcher=OpenLayers.Class(OpenLayers.Control,{layerStates:null,layersDiv:null,baseLayersDiv:null,baseLayers:null,dataLbl:null,dataLayersDiv:null,dataLayers:null,buttonWidth:120,transChange:!1,initialize:function(a){OpenLayers.Control.prototype.initialize.apply(this,arguments);this.layerStates=[]},destroy:function(){OpenLayers.Event.stopObservingElement(this.div);this.clearLayersArray("base");this.clearLayersArray("data");this.map.events.un({addlayer:this.redraw,changelayer:this.redraw,
removelayer:this.redraw,changebaselayer:this.redraw,scope:this});OpenLayers.Control.prototype.destroy.apply(this,arguments)},setMap:function(a){OpenLayers.Control.prototype.setMap.apply(this,arguments);this.map.events.on({addlayer:this.redraw,changelayer:this.redraw,removelayer:this.redraw,changebaselayer:this.redraw,scope:this})},draw:function(){OpenLayers.Control.prototype.draw.apply(this);this.loadContents();this.redraw();return this.div},clearLayersArray:function(a){var c=this[a+"Layers"];if(c)for(var b=
0,d=c.length;b<d;b++)OpenLayers.Event.stopObservingElement(c[b].labelSpan);this[a+"LayersDiv"].innerHTML="";this[a+"Layers"]=[]},checkRedraw:function(){var a=!1;if(!this.layerStates.length||this.map.layers.length!=this.layerStates.length)a=!0;else for(var c=0,b=this.layerStates.length;c<b;c++){var d=this.layerStates[c],e=this.map.layers[c];if(d.name!=e.name||d.inRange!=e.inRange||d.id!=e.id||d.visibility!=e.visibility){a=!0;break}}return a},redraw:function(){if(!this.checkRedraw())return this.div;
this.clearLayersArray("base");this.clearLayersArray("data");var a=this.map.layers.length;this.layerStates=Array(a);for(var c=0;c<a;c++){var b=this.map.layers[c];this.layerStates[c]={name:b.name,visibility:b.visibility,inRange:b.inRange,id:b.id}}for(var d=this.map.layers.slice(),e=-1,c=0,a=d.length;c<a;c++){var b=d[c],f=b.isBaseLayer;f&&(e+=1);if(b.displayInLayerSwitcher){var j=f?b==this.map.baseLayer:b.getVisibility(),h=document.createElement("input");h.id=this.id+"_input_"+b.name;h.name=f?"baseLayers":
b.name;h.type=f?"radio":"checkbox";h.value=b.name;h.checked=j;h.defaultChecked=j;!f&&!b.inRange&&(h.disabled=!0);var k={inputElem:h,layer:b,layerSwitcher:this},g=document.createElement("span");!f&&!b.inRange&&(g.style.color="gray");OpenLayers.Event.observe(g,"click",OpenLayers.Function.bindAsEventListener(this.onInputClick,k));(f?this.baseLayers:this.dataLayers).push({layer:b,inputElem:h,labelSpan:g});(f?this.baseLayersDiv:this.dataLayersDiv).appendChild(g);g.className="labSpanInactive";g.style.position=
"absolute";g.style.left=""+e*this.buttonWidth+"px";j&&(g.className="labSpanActive");f=document.createElement("span");f.className="labelText";f.innerHTML=b.options.displayName&&null!=b.options.displayName&&""!=b.options.displayName?b.options.displayName:"Google Hybrid"==b.name?"Aerial View":"SlippyMap Navteq"==b.name||"SlippyMap W2GI"==b.name?"Street View "+(e+1):b.name;g.appendChild(f)}}return this.div},onInputClick:function(a){this.inputElem.disabled||("radio"==this.inputElem.type?(this.inputElem.checked=
!0,this.layer.map.setBaseLayer(this.layer)):(this.inputElem.checked=!this.inputElem.checked,this.layerSwitcher.updateMap()));OpenLayers.Event.stop(a)},onLayerClick:function(){this.updateMap()},updateMap:function(){for(var a=0,c=this.baseLayers.length;a<c;a++){var b=this.baseLayers[a];b.inputElem.checked&&this.map.setBaseLayer(b.layer,!1)}a=0;for(c=this.dataLayers.length;a<c;a++)b=this.dataLayers[a],b.layer.setVisibility(b.inputElem.checked)},loadContents:function(){this.div.id="layerSwitcherMain";
this.layersDiv=document.createElement("div");this.layersDiv.id="layerSwitcherMain_layersDiv";this.baseLayersDiv=document.createElement("div");this.baseLayersDiv.id="layerSwitcherMain_baseLayersDiv";this.dataLayersDiv=document.createElement("span");this.dataLayersDiv.style.display="none";this.layersDiv.appendChild(this.baseLayersDiv);this.div.appendChild(this.layersDiv);OpenLayers.Event.observe(this.div,"mouseup",OpenLayers.Function.bindAsEventListener(this.mouseUp,this));OpenLayers.Event.observe(this.div,
"click",this.ignoreEvent);OpenLayers.Event.observe(this.div,"mousedown",OpenLayers.Function.bindAsEventListener(this.mouseDown,this));OpenLayers.Event.observe(this.div,"dblclick",this.ignoreEvent);OpenLayers.Util.getImagesLocation();new OpenLayers.Size(18,18)},ignoreEvent:function(a){OpenLayers.Event.stop(a)},mouseDown:function(a){this.isMouseDown=!0;this.ignoreEvent(a)},mouseUp:function(a){this.isMouseDown&&(this.isMouseDown=!1,this.ignoreEvent(a))},CLASS_NAME:"OpenLayers.Control.LayerSwitcher"});
OpenLayers.Icon.IconFromTemplate=OpenLayers.Class(OpenLayers.Icon,{bubbleid:null,initialize:function(a){var c=a.getElementsByTagName("img")[0],c=c._src?c._src:c.src,b=this._getIconSize(a);OpenLayers.Icon.prototype.initialize.apply(this,[c,b,null,function(){return new OpenLayers.Pixel(a.readAttribute("offsetx"),a.readAttribute("offsety"))}]);this.bubbleid=a.getAttribute("bubbleid");(c=a.getElementsByTagName("div")[0])&&this.imageDiv.appendChild(c);Element.extend(this.imageDiv);this.imageDiv.addClassName("icon")},
_getIconSize:function(a){return new OpenLayers.Size(a.readAttribute("width"),a.readAttribute("height"))},CLASS_NAME:"OpenLayers.Icon.IconFromTemplate"});
OpenLayers.Control.MapSlider=OpenLayers.Class(OpenLayers.Control,{panelWidth:null,panelHeight:null,mapMarginLeft:null,mapMarginRight:null,mapMarginTop:null,mapMarginBottom:null,panel:null,effectType:"slide",location:"left",blockMoreEffects:!1,initialize:function(a,c,b){OpenLayers.Control.prototype.initialize.apply(this,arguments);a&&(this.location=a);c&&(this.effectType=c);b&&(this.panel=b)},destroy:function(){this.panel=this.location=this.effectType=this.mapMarginBottom=this.mapMarginTop=this.mapMarginRight=
this.mapMarginLeft=this.panelWidth=null},setMap:function(a){OpenLayers.Control.prototype.setMap.apply(this,arguments);null==this.panel&&(this.panel=this.map.smap.locator.panel);this.panelWidth=this.panel.getStyle("width");this.panelHeight=this.panel.getStyle("height");this.mapMarginLeft=$(this.map.div).getStyle("marginLeft");this.mapMarginRight=$(this.map.div).getStyle("marginRight");this.mapMarginTop=$(this.map.div).getStyle("marginTop");this.mapMarginBottom=$(this.map.div).getStyle("marginBottom")},
_setPosition:function(){switch(this.location){case "left":this.div.style.left="0px";this.div.style.top=this.map.size.h/2+"px";break;case "right":this.div.style.right="0px";this.div.style.top=this.map.size.h/2+"px";break;case "top":this.div.style.left=this.map.size.w/2+"px";this.div.style.top="0px";break;case "bottom":this.div.style.left=this.map.size.w/2+"px",this.div.style.bottom="0px"}},draw:function(){OpenLayers.Control.prototype.draw.apply(this,arguments);this._addSlider();this._addObservers.bind(this).defer();
this._setPosition();return this.div},_addSlider:function(){new OpenLayers.Size(20,20);this.hideArrow=document.createElement("div");this.showArrow=document.createElement("div");Element.extend(this.hideArrow);Element.extend(this.showArrow);this.hideArrow.style.position="relative";this.showArrow.style.position="relative";this.hideArrow.className="olMapSliderHidePanel";this.showArrow.className="olMapSliderShowPanel";this.div.appendChild(this.hideArrow);this.div.appendChild(this.showArrow);this.showArrow.hide()},
_addObservers:function(){OpenLayers.Event.observe(window,"resize",this._updateSize.bindAsEventListener(this));OpenLayers.Event.observe(this.hideArrow,"click",this._hide.bindAsEventListener(this));OpenLayers.Event.observe(this.showArrow,"click",this._show.bindAsEventListener(this))},_hide:function(a){OpenLayers.Event.stop(a);if(!0!=this.blockMoreEffects){this.blockMoreEffects=!0;switch(this.effectType){case "slide":this._hideSlide();break;case "appear":this._hideAppear();break;case "blind":this._hideBlind()}this.hideArrow.hide();
this.showArrow.show()}},_show:function(a){if(!0!=this.blockMoreEffects){this.blockMoreEffects=!0;OpenLayers.Event.stop(a);switch(this.effectType){case "slide":this._showSlide();break;case "appear":this._showAppear();break;case "blind":this._showBlind()}this.showArrow.hide();this.hideArrow.show()}},_hideSlide:function(){switch(this.location){case "left":new Effect.Morph(this.panel,{style:{width:"0px"},duration:0.8});new Effect.Morph(this.map.div,{style:{marginLeft:"0px"},afterFinish:function(){this.panel.style.display=
"none";this._unblock()}.bind(this)});break;case "right":new Effect.Morph(this.panel,{style:{width:"0px"},duration:0.8});new Effect.Morph(this.map.div,{style:{marginRight:"0px"},afterFinish:function(){this.panel.style.display="none";this._unblock()}.bind(this)});break;case "top":new Effect.Morph(this.panel,{style:{width:"0px"},duration:0.8});new Effect.Morph(this.map.div,{style:{marginTop:"0px"},delay:0.8,afterFinish:function(){this.panel.style.display="none";this._unblock()}.bind(this)});break;case "bottom":new Effect.Morph(this.panel,
{style:{width:"0px"},duration:0.8}),new Effect.Morph(this.map.div,{style:{marginBottom:"0px"},delay:0.8,afterFinish:function(){this.panel.style.display="none";this._unblock()}.bind(this)})}},_showSlide:function(){switch(this.location){case "left":this.panel.style.display="block";new Effect.Morph(this.map.div,{style:{marginLeft:this.mapMarginLeft},duration:0.8});new Effect.Morph(this.panel,{style:{width:this.panelWidth},duration:0.8,afterFinish:this._unblock.bind(this)});break;case "right":this.panel.style.display=
"block";new Effect.Morph(this.map.div,{style:{marginRight:this.mapMarginRight},duration:0.8});new Effect.Morph(this.panel,{style:{width:this.panelWidth},duration:0.8,afterFinish:this._unblock.bind(this)});break;case "top":new Effect.Morph(this.map.div,{style:{marginTop:this.mapMarginTop},duration:0.8,afterFinish:function(){this.panel.style.display="block"}.bind(this)});new Effect.Morph(this.panel,{style:{width:this.panelWidth},duration:0.8,delay:0.8,afterFinish:this._unblock.bind(this)});break;case "bottom":new Effect.Morph(this.map.div,
{style:{marginBottom:this.mapMarginBottom},duration:0.8,afterFinish:function(){this.panel.style.display="block"}.bind(this)}),new Effect.Morph(this.panel,{style:{width:this.panelWidth},duration:0.8,delay:0.8,afterFinish:this._unblock.bind(this)})}},_hideAppear:function(){switch(this.location){case "left":new Effect.Opacity(this.panel,{duration:0.8,from:1,to:0});new Effect.Morph(this.panel,{style:{width:"0px"},delay:0.8});new Effect.Morph(this.map.div,{style:{marginLeft:"0px"},delay:0.8,afterFinish:this._unblock.bind(this)});
break;case "right":new Effect.Opacity(this.panel,{duration:0.8,from:1,to:0});new Effect.Morph(this.panel,{style:{width:"0px"},delay:0.8});new Effect.Morph(this.map.div,{style:{marginRight:"0px"},delay:0.8,afterFinish:this._unblock.bind(this)});break;case "top":new Effect.Opacity(this.panel,{duration:0.8,from:1,to:0,afterFinish:function(){this.panel.style.display="none"}.bind(this)});new Effect.Morph(this.map.div,{style:{marginTop:"0px"},delay:0.8,afterFinish:this._unblock.bind(this)});break;case "bottom":new Effect.Opacity(this.panel,
{duration:0.8,from:1,to:0,afterFinish:function(){this.panel.style.display="none"}.bind(this)}),new Effect.Morph(this.map.div,{style:{marginBottom:"0px"},delay:0.8,afterFinish:this._unblock.bind(this)})}},_showAppear:function(){switch(this.location){case "left":new Effect.Morph(this.panel,{style:{width:this.panelWidth},duration:0.8});new Effect.Morph(this.map.div,{style:{marginLeft:this.mapMarginLeft},duration:0.8});new Effect.Opacity(this.panel,{duration:0.8,from:0,to:1,delay:0.8,afterFinish:this._unblock.bind(this)});
break;case "right":new Effect.Morph(this.panel,{style:{width:this.panelWidth},duration:0.8});new Effect.Morph(this.map.div,{style:{marginRight:this.mapMarginRight},duration:0.8});new Effect.Opacity(this.panel,{duration:0.8,from:0,to:1,delay:0.8,afterFinish:this._unblock.bind(this)});break;case "top":new Effect.Morph(this.map.div,{style:{marginTop:this.mapMarginTop},afterFinish:function(){this.panel.style.display="block"}.bind(this)});new Effect.Opacity(this.panel,{duration:0.8,from:0,to:1,delay:0.8,
afterFinish:this._unblock.bind(this)});break;case "bottom":new Effect.Morph(this.map.div,{style:{marginBottom:this.mapMarginBottom},afterFinish:function(){this.panel.style.display="block"}.bind(this)}),new Effect.Opacity(this.panel,{duration:0.8,from:0,to:1,delay:0.8,afterFinish:this._unblock.bind(this)})}},_hideBlind:function(){switch(this.location){case "left":new Effect.BlindUp(this.panel,{duration:0.8});new Effect.Morph(this.map.div,{style:{marginLeft:"0px"},delay:0.8,afterFinish:this._unblock.bind(this)});
break;case "right":new Effect.BlindUp(this.panel,{duration:0.8});new Effect.Morph(this.map.div,{style:{marginRight:"0px"},delay:0.8,afterFinish:this._unblock.bind(this)});break;case "top":Effect.BlindUp(this.panel,{duration:0.8});new Effect.Morph(this.map.div,{style:{marginTop:"0px"},duration:0.8,afterFinish:this._unblock.bind(this)});break;case "bottom":Effect.BlindUp(this.panel,{duration:0.8}),new Effect.Morph(this.map.div,{style:{marginBottom:"0px"},duration:0.8,afterFinish:this._unblock.bind(this)})}},
_showBlind:function(){switch(this.location){case "left":new Effect.BlindDown(this.panel,{duration:0.8,delay:0.8});new Effect.Morph(this.map.div,{duration:0.8,style:{marginLeft:this.mapMarginLeft},afterFinish:this._unblock.bind(this)});break;case "right":new Effect.BlindDown(this.panel,{duration:0.8,delay:0.8});new Effect.Morph(this.map.div,{duration:0.8,style:{marginRight:this.mapMarginRight},afterFinish:this._unblock.bind(this)});break;case "top":Effect.BlindDown(this.panel,{duration:0.8});new Effect.Morph(this.map.div,
{style:{marginTop:this.mapMarginTop},duration:0.8,afterFinish:this._unblock.bind(this)});break;case "bottom":Effect.BlindDown(this.panel,{duration:0.8}),new Effect.Morph(this.map.div,{style:{marginBottom:this.mapMarginBottom},duration:0.8,afterFinish:this._unblock.bind(this)})}},_unblock:function(){this.blockMoreEffects=!1},_updateSize:function(){this._setPosition()},CLASS_NAME:"OpenLayers.Control.MapSlider"});
OpenLayers.Marker.DragabbleMarker=OpenLayers.Class(OpenLayers.Marker,{mouseDragStart:null,mouseDragStartLonLat:null,geocoderAddresses:null,geocoderAddress:null,reverseGeocoderAddress:null,sphericalMercator:!1,initialize:function(a,c,b){OpenLayers.Marker.prototype.initialize.apply(this,arguments);(!b||!b)&&this._registerObservers()},setSphericalMercator:function(a){this.sphericalMercator=a},destroy:function(){OpenLayers.Marker.prototype.destroy.apply(this,arguments);this.reverseGeocoderAddress=this.geocoderAddress=
this.geocoderAddresses=this.mouseDragStartLonLat=this.mouseDragStart=null},reverseGeocode:function(a,c){var b=c&&c.country?c.country:"",d=new OpenLayers.LonLat(this.lonlat.lon,this.lonlat.lat);this.sphericalMercator&&d.transform(new OpenLayers.Projection("EPSG:900913"),new OpenLayers.Projection("EPSG:4326"));b={longitude:d.lon,latitude:+d.lat,country:b};"undefined"==typeof c&&(c={});"undefined"!=ace.cgeo&&(c.clientSide=!0);ace.geo.reverse(b,function(b){this.reverseGeocoderAddress=b;this.geocoderAddress=
null;var c=new OpenLayers.LonLat(b.LONGITUDE,b.LATITUDE);this.sphericalMercator&&c.transform(new OpenLayers.Projection("EPSG:4326"),new OpenLayers.Projection("EPSG:900913"));this.lonlat=c;this.country=b.COUNTRY;if(!a)return!0;try{return a(this)}catch(d){ace.util.alert(d,{height:100})}}.bind(this),c)},geocode:function(a,c,b){function d(a){this.geocoderAddresses=a;this.reverseGeocoderAddress=null;if(!c)return!0;try{return c(this)}catch(b){ace.util.alert(b,{height:100})}}""!=a&&ace.geo.code(a,d.bind(this),
b)},moveToLonLat:function(a){a=this.map.getLayerPxFromLonLat(a||this.lonlat);this.moveTo(a)},getAddress:function(){return this.geocoderAddress?this.geocoderAddress:this.geocoderAddresses?this.geocoderAddresses[0]:this.reverseGeocoderAddress?this.reverseGeocoderAddress:{LONGITUDE:""+this.lonlat.lon,LATITUDE:""+this.lonlat.lat}},_registerObservers:function(){this.events.register("mousedown",this,this._markerDown);this.events.registerPriority("mouseup",this,this._markerUp)},_markerDown:function(a){this.map.events.registerPriority("mousemove",
this,this._markerDrag);a.xy||this.adjustXY(a);this.mouseDragStartLonLat=this.map.getLonLatFromPixel(a.xy);this.mouseDragStart=a.xy;OpenLayers.Event.stop(a)},_markerDrag:function(a){if(this.mouseDragStart){a.xy||this.adjustXY(a);var c=this.mouseDragStart.x-a.xy.x,b=this.mouseDragStart.y-a.xy.y,d=this.icon.imageDiv.style,c=parseInt(d.left)-c,b=parseInt(d.top)-b;d.left=c+"px";d.top=b+"px";this.mouseDragStart=a.xy;OpenLayers.Event.stop(a)}},_markerUp:function(a){if(OpenLayers.Event.isLeftClick(a)){this.map.events.unregister("mousemove",
this,this._markerDrag);this.reverseGeocoderAddress=this.geocoderAddress=null;a.xy||this.adjustXY(a);var c=this.map.getLonLatFromPixel(a.xy);this.lonlat=this.lonlat.add(c.lon-this.mouseDragStartLonLat.lon,c.lat-this.mouseDragStartLonLat.lat);this.mouseDragStart=null;OpenLayers.Event.stop(a)}},adjustXY:function(a){a.xy={x:a.clientX,y:a.clientY};var c=OpenLayers.Util.pagePosition(this.map.viewPortDiv);a.xy.x-=c[0];a.xy.y-=c[1]},CLASS_NAME:"OpenLayers.Marker.DragabbleMarker"});
var SlippyMap={locator:null,load:function(a,c,b){ace.template.initialize();ace.util.checkNumberFormat();SlippyMap.locator=new SlippyMap.Locator(a,c,b)},unload:function(){SlippyMap.locator&&(SlippyMap.locator.destroy(),SlippyMap.locator=null);ace.template&&ace.template.destroy();ace.cache&&ace.cache.destroy()},VERSION_NUMBER:"1.79.6"};
SlippyMap.Popup=Class.create({smap:null,initialize:function(a){this.smap=a;this.smap.map.events.register("popupclose",this,this._popupClose);document.on("w2gi:popupopen",this._popupOpen.bind(this));document.on("w2gi:popupclose",this._popupClose.bind(this))},destroy:function(){this.smap=null},_popupOpen:function(a){a=a.memo.data;this._addObservers.bind(this,a).defer();var c=this.smap.locator.panel.down();ace.table.updateActiveRow(c,a.recnum);c=ace.util.getCookie("mylocation");a=$(a.div).down(".make_default_loc");
if(c&&a)for(var c=c.split("|"),b=0;b<c.length;b++)a.readAttribute("clientkey")==c[b]&&(a.checked=!0)},_popupClose:function(a){a=a.memo.data;this.smap.map.removePopup(a);if((a=this.smap.proximityLayer.features[a.recnum])&&a.popup)a.popup.destroy(),a.popup=null;a=this.smap.locator.panel.down();ace.table.updateActiveRow(a)},_addObservers:function(a){var c=$$(".bubble_close"),b=$$(".tab_label");c&&c.each(function(b){b.observe("click",function(){this.hide()}.bind(a))});var d=Element.extend(a.div.getElementsByTagName("form")[0]);
b.each(function(b){Event.observe(b,"click",this._selectTab.bind(this,b,a.div,d))}.bind(this));if(d){if(d.visible())var e=setInterval(function(){Form.focusFirstElement(d);clearInterval(e)},500);this._addFormObservers(d)}a.div.on("click",function(a){var b=a.target.tagName;"click"!==a.type&&a.stop();!(a.target.type&&"checkbox"==a.target.type)&&"a"!=b.toLowerCase()&&a.stop();switch($(a.target).readAttribute("action")){case "more_info":a=a.target.readAttribute("recnum");ace.table.oldrecords=ace.table.data[this.smap.locator.panelID].records.clone();
ace.table.selected=a;a=ace.table.data[this.smap.locator.panelID].records.slice(a-1,a);a[0].RECNUM=1;a[0].POINUM=1;this.smap.locator.clear();ace.table.updateFromRecords(this.smap.locator.panel,a,{NAME:"more_info"});this.smap.proximityLayer.addPOIMarker(a[0]);this.smap.zoomToPOI(a,1);break;case "make_default_loc":this.smap.locator.proximitySearch._makeDefaultLocation(a.target,a.target.readAttribute("uid"));break;case "GSView_bubble_open":var a=a.target.readAttribute("recnum"),b=ace.table.getRecord(a,
this.smap.locator.panelID),a=parseFloat(b.LATITUDE),b=parseFloat(b.LONGITUDE),c=new google.maps.LatLng(a,b),d={heading:34,pitch:10,zoom:1};(new google.maps.StreetViewService).getPanoramaByLocation(c,50,function(a,b){b==google.maps.StreetViewStatus.OK?($("gboxDiv").style.display="block",$("innerGbox").style.display="block",new google.maps.StreetViewPanorama(document.getElementById("streetViewCtn"),{position:c,pov:d,visible:!0})):($("gboxDiv").style.display="block",$("innerGbox").style.display="block",
$("streetViewCtn").setStyle({backgroundColor:"#fff",fontsize:"large"}),new google.maps.StreetViewPanorama(document.getElementById("streetViewCtn"),{position:c,pov:d,visible:!1}),$("streetViewCtn").innerHTML="<h1>We are sorry, street view for this area is not available at this moment.</h1>")});break;default:if("a"==b.toLowerCase()){b=a.target.readAttribute("href");if(a.target.hasClassName("lightwindow")){a.stop();ace.util.alertExternal(a.target);break}var e=a.target.readAttribute("onclick");void 0==
e||null==e||""==e?(a.target.readAttribute("target"),"http"==b.substr(0,4)&&window.open(b)):"click"!==a.type&&(a.target.fireEvent?a.target.fireEvent("onclick"):(b=document.createEvent("Events"),b.initEvent("click",!0,!1),a.target.dispatchEvent(b)))}}}.bind(this));a.div.on("touchend",function(a){a.stop();if(a.target.fireEvent)a.target.fireEvent("onclick");else{var b=document.createEvent("Events");b.initEvent("click",!0,!1);a.target.dispatchEvent(b)}});document.fire("w2gi:bubbleOpen",{form:d})},_addFormObservers:function(a){var c=
a.getElementsByTagName("input")[0],b=a.getElementsByTagName("input")[1];Event.observe(b,"click",function(a){this.smap.locator.directionsSearch.bubbleSearch(a)}.bind(this));Event.observe(c,"keypress",function(a){a.keyCode==Event.KEY_RETURN&&this.smap.locator.directionsSearch.bubbleSearch(a)}.bind(this));Event.observe(a,"submit",function(a){a.stop()});var d=a.getElementsByTagName("a")[0];if(d)Event.observe(d,"click",function(b){b.stop();b=ace.util.select(a,"dir")[0];"To"==d.innerHTML?(d.innerHTML="From",
b.innerHTML="Get directions to:"):(d.innerHTML="To",b.innerHTML="Get directions from:");c.visible()&&c.focus()});else{var e=a.select("#linkFrom","#linkTo"),f=a.select("#dirFrom","#dirTo");e.each(function(a){$(a).observe("click",function(a){a.stop();f.invoke("toggle");e.invoke("toggle");c.visible()&&c.focus()})})}},_selectTab:function(a,c,b){var c=$$(".tab_label").reject(function(a){return!a.descendantOf("templates")}).length,d=$$(".tab_label").indexOf(a)-c,a=$$(".bubble_tab").reject(function(a){return a.descendantOf("templates")}),
e=$$(".bubble_tab_dual").reject(function(a){return a.descendantOf("templates")}),f=$$(".tab_content").reject(function(a){return a.descendantOf("templates")});a.each(function(a,c){d==c?(f[c].addClassName("activetabcontent"),f[c].removeClassName("nonactivetabcontent"),a.addClassName("activetab"),a.removeClassName("nonactivetab"),$$(".tab"+(c+1)+"label")[1].removeClassName("activetablabel"),$$(".tab"+(c+1)+"label")[1].addClassName("activetablabel"),b&&b.visible()&&Form.focusFirstElement(b)):(f[c].removeClassName("activetabcontent"),
f[c].addClassName("nonactivetabcontent"),a.addClassName("nonactivetab"),a.removeClassName("activetab"),$$(".tab"+(c+1)+"label")[1].removeClassName("activetablabel"))}.bind(this));e.each(function(a,c){var k=a.id;d==c?(f.length==e.length&&(f[c].addClassName("activetabcontent"),f[c].removeClassName("nonactivetabcontent")),a.addClassName("active"+k),a.removeClassName("nonactivetab"),b&&b.visible()&&Form.focusFirstElement(b)):(f.length==e.length&&(f[c].removeClassName("activetabcontent"),f[c].addClassName("nonactivetabcontent")),
a.addClassName("nonactivetab"),a.removeClassName("active"+k))}.bind(this))},selectTabLabel:function(a){if(a){var c=$$(".tab_label").reject(function(a){return a.descendantOf("templates")}).find(function(b){return b.innerHTML==a});c&&this._selectTab(c)}}});
SlippyMap.Util={addHistory:function(a,c){if(SlippyMap.locator){var b="";if($("locator_search"))b="locator_search";else if($("product_search"))b="product_search";else if($("getlist_search"))b="getlist_search";else return;var d=$(b).visible()?b:"driving_directions",d={formID:d,qs:Form.serialize($(d)),update:function(){var a=$(this.formID);a.visible()||($(this.formID==b?"driving_directions":b).hide(),a.show(),Form.focusFirstElement(a));Form.deserialize(a,this.qs)}},e={xml_request:a,processResponse:c,
center:SlippyMap.locator.smap.map.getCenter(),zoom:SlippyMap.locator.smap.map.getZoom(),update:function(){SlippyMap.locator.clear();var a=ace.cache.get(this.xml_request);a&&this.processResponse(a)}};ace.history.add([d,e])}},isSearchFormValid:function(a){var c=!0;if(!a)return null;$(a).getInputs("text","addressline").each(function(a){a.value=a.value.strip();if(""==a.value)throw c=!1,$break;}.bind(this));return c},lowerCaseObject:function(a){var c={},b;for(b in a)c[b.toLowerCase()]=a[b];return c},getAddressline:function(a){var c=
"",b="",d="",e="";a.ADDRESS1&&(c=a.ADDRESS1.blank()?"":a.ADDRESS1.strip()+", ");a.CITY&&(b=a.CITY.empty()?"":a.CITY+", ");a.COUNTRY&&(d="US"!=a.COUNTRY?a.PROVINCE&&!a.PROVINCE.blank()?a.PROVINCE+" ":"":a.STATE&&!a.STATE.blank()?a.STATE+" ":"");a.POSTALCODE&&(e=a.POSTALCODE.empty()?"":a.POSTALCODE);return c+b+d+e},guessProjection:function(a){var c=a.lon,a=a.lat;return-180<=c&&180>=c&&-90<=a&&90>=a?"EPSG:4326":"EPSG:900913"}};
SlippyMap.IconBar=Class.create({initialize:function(a){this.locator=a;this._addObservers()},destroy:function(){this._removeObservers()},printURL:function(a){Prototype.Browser.WebKit&&(navigator.appVersion.include("523")||navigator.userAgent.include("523"))&&alert("Safari 3.0.4 is unsupported with SlippyMap static maps used in printing.  Please upgrade to properly use the print feature.");var c=location.href.substring(0,location.href.lastIndexOf("/")+1)+a,b=this._getForm();if(SlippyMap.Util.isSearchFormValid(b)){var d=
Form.serialize(b),e=Math.random(),c=c+("?form="+b.readAttribute("id")+"&"+d+"&like="+e);this.locator.uid&&(c+="&uid="+this.locator.uid);this.locator.locatorType&&("product"==this.locator.locatorType&&10>this.locator.panel.innerHTML.length)&&(c=a+"?uid="+this.locator.uid)}b&&("driving_directions"==b.readAttribute("id")&&SlippyMap.locator&&SlippyMap.locator.directionsSearch&&SlippyMap.locator.directionsSearch.addresses)&&(a=SlippyMap.locator.directionsSearch.addresses,a[0]&&(a[0].LATITUDE&&a[0].LONGITUDE)&&
(c+="&latitude="+a[0].LATITUDE,c+="&longitude="+a[0].LONGITUDE),a[1]&&(a[1].LATITUDE&&a[1].LONGITUDE)&&(c+="&dest_latitude="+a[1].LATITUDE,c+="&dest_longitude="+a[1].LONGITUDE));document.fire("w2gi:printPage",{form:b.serialize(!0)});return c},ddSendEmail:function(a){var c=ace.table.data[this.locator.panel.id].options.attributes.EMAILMAPURL;c||(c=this.locator.directionsSearch.mapurl.gsub("getdirectionsmap","emaildirectionstart"));a&&(c=c+"&template="+a);a="";if(Prototype.Browser.IE)a=(a=ace.xml.getFormData(null,
"drivingdirections").xml.match(/<language>(.*)<\/language>/))&&1<a.length?a[1]:"";else{var b=$$("route language");0<b.length&&(a=b[0].innerHTML)}var d,e,f;d=ace.template.getTemplate("ddstarticon")||ace.template.getTemplate("default");b=ace.template.getTemplate("ddendicon")||ace.template.getTemplate("default");d&&0<d.select("img").length&&(d=d.select("img")[0].getAttribute("src"))&&(e=d.slice(d.lastIndexOf("/")+1));b&&0<b.select("img").length&&(d=b.select("img")[0].getAttribute("src"))&&(f=d.slice(d.lastIndexOf("/")+
1));c+=(e?"&icon_start="+e:"")+(f?"&icon_end="+f:"");0<a.length&&(c+="&language="+a);return c},ddSendSMS:function(a){var c=ace.table.data[this.locator.panel.id].options.attributes.MOBILEMAPURL;c||(c=this.locator.directionsSearch.mapurl.gsub("getdirectionsmap","smsdirectionstart"));a&&(c=c+"&template="+a);return c},_addObservers:function(){if($("icon_bar")){var a=$("page_print");a&&a.observe("click",this._printPage);(a=$("page_email"))&&a.observe("click",this._emailPage.bind(this));(a=$("page_link"))&&
a.observe("click",this._linkToPage.bind(this,a))}},_removeObservers:function(){if($("icon_bar")){var a=$("page_print");a&&a.stopObserving();(a=$("page_email"))&&a.stopObserving();(a=$("page_link"))&&a.stopObserving()}},_printPage:function(){document.fire("w2gi:printPage",{});print()},_emailPage:function(){var a=this._getForm(),c=this._getURL(a),b=$("page_email").getAttribute("subject");document.fire("w2gi:emailPage",{form:a.serialize(!0),subject:b,url:c});location.href="mailto:?subject="+b+"&body="+
encodeURIComponent(c)},_linkToPage:function(a){var c=this._getForm(),b=$("linktopage"),d,e,f;b&&null!=b&&(d=b.innerHTML,e=a.readAttribute("close_text"),f=a.readAttribute("title_text"));if(void 0==d||null==d||!d)d='<div id="LB_msg"><span>Paste this link into an email message or IM</span><p><input type="text" onClick="Form.Element.activate(this)" size="60" value="#{URL}" /></div></p>';d=(new Template(d)).evaluate({URL:this._getURL(c)});document.fire("w2gi:linkToPage",{form:c.serialize(!0)});ace.util.alert(d,
{width:425,height:120,close_text:e,title_text:f})},_getURL:function(a){var c=location.href.indexOf("?"),b=0<c?location.href.substring(0,c):location.href,c=location.href.indexOf("#"),b=0<c?b.substring(0,c):b;SlippyMap.Util.isSearchFormValid(a)&&(c=Form.serialize(a),b+="?form="+a.readAttribute("id")+"&"+c);return b},_getForm:function(){var a=$("locator_search");if(!a||!a.visible())if(a=$("product_search"),!a||!a.visible())if(a=$("driving_directions"),!a||!a.visible())if(a=$("multipoint_driving_directions"),
!a||!a.visible())a=$("getlist_search");return a}});
SlippyMap.Locator=Class.create({panel:null,whereamiDiv:null,sku:null,uid:null,smap:null,iconBar:null,proximitySearch:null,directionsSearch:null,initialize:function(a,c,b){function d(a){var a=ace.xml.parse(a),c=a[0].COUNTRY.toUpperCase();if(b.language&&null!=b.language&&""!=b.language){var d=!1;$H(b.language).each(function(a){if(-1!=a.key.indexOf(","))for(var b=a.key.split(","),e=0;e<b.length;e++){if(-1!=c.indexOf(b[e].toUpperCase)&&(d=!0,a.value.template&&null!=a.value.template&&""!=a.value.template)){var f=
c.href,f=f.substring(f.lastIndexOf("/")+1,f.length);f!=a.value.template&&(c.href=a.value.template)}}else-1!=c.indexOf(a.key.toUpperCase())&&(d=!0,a.value.template&&(null!=a.value.template&&""!=a.value.template)&&(f=c.href,f=f.substring(f.lastIndexOf("/")+1,f.length),f!=a.value.template&&(c.href=a.value.template)))});d&&ace.locale.loadLocale(e)}}Object.extend(this,b||{});this.mapID=a;this.panelID=c;this.panel=$(c);this.alertError=b.alertError;null==this.alertError&&(this.alertError=!0);if(b.defaultLanguage&&
null!=b.defaultLanguage&&""!=b.defaultLanguage&&!0==b.defaultLanguage){var e=window.navigator.language||window.navigator.userLanguage,e=e.replace("-","_");if(b.language&&null!=b.language&&""!=b.language){var f=!1;$H(b.language).each(function(a){if(-1!=e.indexOf(a.value.lang)&&(f=!0,a.value.template&&null!=a.value.template&&""!=a.value.template)){var b=location.href,b=b.substring(b.lastIndexOf("/")+1,b.length);b!=a.value.template&&(location.href=a.value.template)}});f&&ace.locale.loadLocale(e)}}else b.language&&
(null!=b.language&&""!=b.language)&&(c={},"undefined"!=typeof Console&&$("accounts")?c.schemaname=$("accounts").getValue():c.appkey=ace.xml.getXMLData("appkey"),ace.request(c,d,{formdataID:"getcountry"}));b.whereamiDiv&&null!=b.whereamiDiv&&(this.whereamiDiv=b.whereamiDiv);ace.geo.initialize();b.ddpanel&&""!=b.ddpanel&&(this.ddpanel=b.ddpanel);b.formdataid?this.formdataid=b.formdataid:this.formdataid="locatorsearch";this._setURLParams(!1);this._custom=new Custom(this);if(b.locatorType&&"product"!=
b.locatorType&&(b.onlineStores||b.onlinePanel))this.productSearch=new SlippyMap.Search.ProximitySearch.Product(this);if(b.locatorType&&"product"==b.locatorType)this.iconBar=new SlippyMap.IconBar(this),this.smap=new SlippyMap.Smap(this,a,b),this.searchFormId="product_search",this.proximitySearch=new SlippyMap.Search.ProximitySearch.Product(this),this.directionsSearch=new SlippyMap.Search.DirectionsSearch(this),b.multipointDirections&&(this.directionsSearch=new SlippyMap.Search.MultipointDirectionsSearch(this));
else if(b.locatorType&&"getlist"==b.locatorType)this.iconBar=new SlippyMap.IconBar(this),this.smap=new SlippyMap.Smap(this,a,b),this.searchFormId="getlist_search",this.proximitySearch=new SlippyMap.Search.ProximitySearch(this),this.directionsSearch=new SlippyMap.Search.DirectionsSearch(this),b.multipointDirections&&(this.directionsSearch=new SlippyMap.Search.MultipointDirectionsSearch(this));else if(!b.locatorType||b.locatorType&&"locator"==b.locatorType)this.iconBar=new SlippyMap.IconBar(this),this.smap=
new SlippyMap.Smap(this,a,b),this.searchFormId="locator_search",this.proximitySearch=new SlippyMap.Search.ProximitySearch(this),this.directionsSearch=new SlippyMap.Search.DirectionsSearch(this),b.multipointDirections&&(this.directionsSearch=new SlippyMap.Search.MultipointDirectionsSearch(this));this._addMessageObservers();this._load(b)},destroy:function(){this.panel.stopObserving();this.panel=null;this.smap.destroy();this.smap=null;this.iconBar.destroy();this.iconBar=null;this.proximitySearch.destroy();
this.proximitySearch=null;this.directionsSearch.destroy();this.directionsSearch=null},clear:function(){this.panel.innerHTML="";this.smap.clear();ace.table.data[this.panelID]&&(ace.table.data[this.panelID].records&&0<ace.table.data[this.panelID].records.length)&&ace.table.data[this.panelID].records.clear()},_setURLParams:function(a){var c=ace.util.retrieveGetVals();this.url_params={prox:{},prod:{},etail:{}};this.extra_params&&Object.extend(this.url_params,this.extra_params);this.proximityExclude=["form",
"addressline"];this.productExclude=["form","addressline"];this.etailerExclude=["form","addressline"];this.proximityNoStay=["geoip","clientkey"];this.productNoStay=["geoip"];this.etailerNoStay=["geoip"];$H(c).each(function(b){a?(b.key&&(-1==this.proximityExclude.indexOf(b.key)&&-1==this.proximityNoStay.indexOf(b.key))&&(this.url_params.prox[b.key]=b.value),b.key&&(-1==this.productExclude.indexOf(b.key)&&-1==this.productNoStay.indexOf(b.key))&&(this.url_params.prod[b.key]=b.value),b.key&&(-1==this.etailerExclude.indexOf(b.key)&&
-1==this.etailerNoStay.indexOf(b.key))&&(this.url_params.etail[b.key]=b.value)):(b.key&&-1==this.proximityExclude.indexOf(b.key)&&(this.url_params.prox[b.key]=b.value),b.key&&-1==this.productExclude.indexOf(b.key)&&(this.url_params.prod[b.key]=b.value),b.key&&-1==this.etailerExclude.indexOf(b.key)&&(this.url_params.etail[b.key]=b.value))}.bind(this))},clearLocator:function(){this.clear();this.smap.proximityLayer.addCenterMarker(this.smap.map.center)},displayInitialPOIs:function(a){ace.table.updateFromResponseXML(this.panel,
a);this.proximitySearch._updateLayer(a);a=this.smap.zoomToPOIs();this.smap.proximityLayer.update(a.getCenterLonLat())},_load:function(a){a.filters&&Object.extend(ace.filters.active,a.filters);document.fire("w2gi:locatorload",{options:a});this._deserializeSearchForm();if(location.href.include(this.panel)||location.href.include("driving_directions")||location.href.include(this.searchFormId))this._displayBookmark(a);else if(this.geoip||this.defaultLocation||this.autosearch||this.gps){if(this.geoip){var c=
document.createElement("input");c.setAttribute("type","hidden");c.setAttribute("id","geoip_state");c.setAttribute("name","geoip");c.setAttribute("value","start");var b=$("locator_search");b&&b.appendChild(c)}c=(c=ace.util.getCookie(this.clientCookie&&this.clientCookie.name?this.clientCookie.name:"mylocation"))&&c.length?c.split("|"):[];c.length&&this.defaultLocation&&(this.url_params.prox.clientkey=c[0],a.geoip=!1,a.formdataid="getlist");if(this.url_params.prox.uid&&("undefined"==this.url_params.prox.uid||
null==this.url_params.prox.uid))this.url_params.prox.uid="";if(this.searchFormId&&"locator_search"==this.searchFormId)var d=$(this.searchFormId).serialize(!0);(c=this.locatorType&&"product"==this.locatorType?this.url_params.prod:this.url_params.prox)||(c={});this.searchFormId&&"locator_search"==this.searchFormId&&Object.extend(c,d);d={formdataID:a.formdataid,geoip:a.geoip,gps:a.gps,alertError:!1,onError:this._bookmarkError.bind(this)};this.autosearch&&(a.formdataid="getlist",d.formdataID="getlist",
d.tagName="where");this.defaultLocation&&Object.extend(d,{tagName:"where",objectName:"Locator::Store"});a.formdataid&&null!=a.formdataid?this.proximitySearch.search(c,d):this.proximitySearch.search(c,{formdataID:this.formdataid,geoip:a.geoip,gps:a.gps,alertError:!1,onError:this._bookmarkError.bind(this)})}else(d=ace.xml.getXML()[0])?0<d.getElementsByTagName("poi").length?(this.displayInitialPOIs(d),this._addHistory()):this._bookmarkError():this._bookmarkError(),this.proximitySearch&&(d=this.panel.down("form"),
$(this.panel)&&(d&&(void 0==a.nofocus||!1==a.nofocus))&&Form.focusFirstElement(d));this._setURLParams(!0);document.fire("w2gi:locatorloaded",{options:a})},_deserializeSearchForm:function(){var a=$(this.searchFormId),c=Object.toQueryString(this.url_params.prox);a&&Form.deserialize($(this.searchFormId),c);(a=$("getlist_search"))&&Form.deserialize(a,c)},_bookmarkError:function(a){if(this.proximitySearch){var c=$("geoip_state");c&&("start"==c.value?c.setAttribute("value","1"):c.setAttribute("value","0"));
var c=this.defaultZoom?this.defaultZoom:1,b=new OpenLayers.LonLat(this.defaultLon?this.defaultLon:this.center?this.center.lon:-98.15261705337687,this.defaultLat?this.defaultLat:this.center?this.center.lat:40.53681640918523),b=b.transform(new OpenLayers.Projection("EPSG:4326"),new OpenLayers.Projection("EPSG:900913"));this.smap.map.setCenter(b,c);this.whereamiDiv&&null!=this.whereamiDiv&&this.proximitySearch._updateLocation({});c=this.panel.down("form");$(this.panel)&&c&&Form.focusFirstElement(c)}document.fire("w2gi:proximitySearchError",
{xml:a})},_displayBookmark:function(a){if(-1!=location.href.indexOf("?")){this.searchFormId||(this.searchFormId="locator_search");var c=ace.util.retrieveGetVals(),b=$("orig_country"),d=$("dest_country");b&&(d&&c.dest_country&&c.orig_country)&&(b.value=c.orig_country,d.value=c.dest_country);if(c=location.href.include(this.searchFormId)?this.searchFormId:"driving_directions"){b=$(c);b.visible()||(d=c==this.searchFormId?"driving_directions":this.searchFormId,$(d)&&$(d).hide(),b.show());(void 0==a.nofocus||
!1==a.nofocus)&&Form.focusFirstElement(b);var a=location.href.sub("form="+c+"&",""),d=a.substring(a.indexOf("?")+1),e=d.split("&");e.each(function(a,b){-1!=a.indexOf("addressline")&&(e[b]=a.gsub(/\+/," "))}.bind(this));var d=e.join("&"),f=this.locatorType&&"product"==this.locatorType?this.url_params.prod:this.url_params.prox;f||(f={});Form.deserialize(b,d);a=a.include("geoip=1")?1:0;this.lateDeserialize&&this._deserializeSearchForm();a={onError:this._bookmarkError.bind(this),geoip:a};c==this.searchFormId?
this.proximitySearch._search(b,a):this.directionsSearch&&this.directionsSearch.search(b)}}},_addHistory:function(){formHistory={qs:$(this.panel)&&$(this.panel).getInputs?Form.serializeElements($(this.panel).getInputs("text","addressline")):"",update:function(){var a=$(this.panel);a.visible()||($("driving_directions").hide(),a.show(),Form.focusFirstElement(a));Form.deserialize(a,this.qs)}};poiHistory={update:function(){SlippyMap.locator.clear();var a=ace.xml.getXML()[0].getElementsByTagName("poi");
SlippyMap.locator.displayInitialPOIs(a)}};ace.history.add([formHistory,poiHistory])},_addMessageObservers:function(){"undefined"!=typeof this.panel&&this.panel&&($("panel_load_message")&&(this.panel.innerHTML=$("panel_load_message").innerHTML),document.observe("w2gi:proximityresponse",function(){this.panel.show()}.bind(this)),document.observe("w2gi:proximitySearchError",function(){this.panel.show();this.clearLocator();$("panel_error_message")&&(this.panel.innerHTML=$("panel_error_message").innerHTML)}.bind(this)));
if("undefined"!=typeof this.onlinePanel&&this.onlinePanel&&$(this.onlinePanel)){var a=$(this.onlinePanel);$("online_panel_load_message")&&(a.innerHTML=$("online_panel_load_message").innerHTML);document.observe("w2gi:onlineProductSearch",function(){a.show()}.bind(this));document.observe("w2gi:onlineProductError",function(){a.show();$("online_panel_error_message")&&(a.innerHTML=$("online_panel_error_message").innerHTML)}.bind(this))}}});
SlippyMap.Smap=Class.create({locator:null,map:null,popup:null,proximityLayer:null,routeLayer:null,routeMarkerLayer:null,slider:null,copyrightBottom:null,initialize:function(a,c,b){this.locator=a;a={scales:[5E7,2E7,1E7,4E6,1E6,5E5,15E4,1E5,5E4,25E3,15E3,6E3],smap:this};Object.extend(a,b||{});var d;b&&(d={highlight:b.highlight?b.highlight:!1,highlightEffect:b.highlightEffect?b.highlightEffect:!1});this.map=this._initOpenLayers(c,a);this.popup=new SlippyMap.Popup(this);this.routeLayer=this.map.routeStyle&&
this._isVectorLayerSupported()?new SlippyMap.Layer.RouteVectorLayer(this,"Route vector"):new SlippyMap.Layer.RouteImageLayer(this,"Route image");this.routeMarkerLayer=new SlippyMap.Layer.RouteMarkerLayer(this,"Route markers");this.proximityLayer=new SlippyMap.Layer.ProximityLayer(this,"Proximity markers",d);this._addCopyright(this.map.div);this.map.events.register("changebaselayer",this,this._updateCopyrightPosition);this.map.events.register("click",this,this._closePopup);this.map.events.register("touchend",
this,this._closePopup);this.copyrightBottom=$("w2gi_copyright").getStyle("bottom");this._addAjaxActivityIndicator(this.map.div);this.map.disableClickTrack||document.observe("w2gi:track",function(a){a.stop();ace.click.track(a.memo)});if(Prototype.Browser.IE&&10>document.documentMode||Prototype.Browser.Gecko)document.fire("w2gi:track",{action:"mapstartview",value:(new Date).toString()}),window.onbeforeunload=function(){document.fire("w2gi:track",{action:"mapendview",value:(new Date).toString()})}},
destroy:function(){this.popup.destroy();this.routeLayer.destroy();this.routeMarkerLayer.destroy();this.proximityLayer.destroy();this.map.events.unregister("click",this,this._closePopup);this.map.events.unregister("touchend",this,this._closePopup);this.map.events.unregister("changebaselayer",this,this._updateCopyrightPosition);this.map.disableClickTrack||document.stopObserving("w2gi:track")},clear:function(){this.proximityLayer.clear();this.routeLayer.clear();this.routeMarkerLayer.clear();this.map.removePopups()},
zoomToPOIs:function(a){var c=this.getPOIBounds(ace.table.data[this.locator.panelID].records),b;if((b=this.locator.proximitySearch||this.locator.productSearch||null)&&b.centerPoint){if(b=this.locator.proximitySearch.centerPoint.clone(),"EPSG:900913"==this.map.baseLayer.projection.toString()){var d,e;d=b.lon;e=b.lat;"EPSG:900913"!==(-180<=d&&180>=d&&-90<=e&&90>=e?"EPSG:4326":"EPSG:900913")&&b.transform(new OpenLayers.Projection("EPSG:4326"),this.map.baseLayer.projection)}}else b=c.getCenterLonLat();
a||c.extend(b);c=this.padBounds(c);this.map.zoomToExtent(c);return c},zoomToPOI:function(a,c){var b=this.getPOIBounds(a);c||b.extend(this.locator.proximitySearch.centerPoint);this.map.zoomToExtent(b);return b},findControl:function(a){return this.map.controls.find(function(c){return c.CLASS_NAME==a})},padBounds:function(a){var c=this.locator.padBounds,c="undefined"!=typeof c||null!=c?c:0.0125;"EPSG:900913"==this.map.baseLayer.projection.toString()&&(c=1291.49);return new OpenLayers.Bounds(a.left-c,
a.bottom-c,a.right+c,a.top+c)},getPOIBounds:function(a){for(var c=180,b=-180,d=90,e=-90,f=0,j=a.length;f<j;f++){var h=parseFloat(a[f].LONGITUDE),k=parseFloat(a[f].LATITUDE);!isNaN(h)&&!isNaN(h)&&(c=Math.min(c,h),b=Math.max(b,h),d=Math.min(d,k),e=Math.max(e,k))}a=new OpenLayers.Bounds(c,d,b,e);"EPSG:900913"==this.map.baseLayer.projection.toString()&&a.transform(new OpenLayers.Projection("EPSG:4326"),this.map.baseLayer.projection);return a},_initOpenLayers:function(a,c){var b=this._getSources(),b=this._getLayers(b);
b[0].options&&Object.extend(c,b[0].options);var d=new OpenLayers.Map(a,c);d.addLayers(b);return d},_updateCopyrightPosition:function(){switch(this.map.baseLayer.CLASS_NAME){case "OpenLayers.Layer.Yahoo":$("w2gi_copyright").setStyle({bottom:"30px"});break;case "OpenLayers.Layer.VirtualEarth":$("w2gi_copyright").setStyle({bottom:"50px"});break;default:$("w2gi_copyright").setStyle({bottom:this.copyrightBottom})}"SlippyMap Navteq"==this.map.baseLayer.name?$("navteq_copyright").show():$("navteq_copyright").hide();
"SlippyMap Navteq"==this.map.baseLayer.name?$("navteqfooter").show():$("navteqfooter").hide();"SlippyMap W2GI"==this.map.baseLayer.name?$("osm_copyright").show():$("osm_copyright").hide();"SlippyMap Navteq"==this.map.baseLayer.name||"SlippyMap W2GI"==this.map.baseLayer.name?$("w2gi_copyright").show():$("w2gi_copyright").hide()},_closePopup:function(){var a=this.map.popups[0];a&&document.fire("w2gi:popupclose",{data:a})},_getSources:function(){var a=ace.xml.getXML()[0].getElementsByTagName("sources")[0];
a||(a=ace.xml.getXML()[0].getElementsByTagName("layer")[0]);return ace.xml.parse(a)},_getLayers:function(a){return a.map(function(a){var b=null,b={},d=a.OPTIONS.evalJSON(),d=Object.extend(b,d);switch(a.NAME){case "SlippyMap Navteq":return b={g:"__base__",i:"PNG8",appkey:ace.xml.getXMLData("appkey"),projection:new OpenLayers.Projection("EPSG:4326"),maxExtent:new OpenLayers.Bounds(-165,15,-50,75),units:"degrees",sphericalMercator:!1,maxResolution:1.40625},Object.extend(d,b),b=$w(a.IMAGEURL.gsub(",",
" ")),new OpenLayers.Layer.KaMap(a.NAME,b,d,{buffer:0,projection:"EPSG:4326",resolutions:[0.15873908440210452,0.06349563376084183,0.031747816880420915,0.012699126752168366,0.0031747816880420914,0.0015873908440210457,4.762172532063137E-4,3.1747816880420905E-4,1.5873908440210453E-4,7.936954220105226E-5,4.7621725320631366E-5,1.9048690128252544E-5]});case "OpenLayers WMS":return b=$w(a.IMAGEURL.gsub(","," ")),new OpenLayers.Layer.WMS(a.NAME,b,d);case "Google Satellite":case "Google Normal":case "Google Hybrid":case "Google Streets":return new OpenLayers.Layer.Google(a.NAME,
d);case "Yahoo Regular":case "Yahoo Satellite":case "Yahoo Hybrid":return new OpenLayers.Layer.Yahoo(a.NAME,d);case "Virtual Earth Aerial":case "Virtual Earth Road":case "Virtual Earth Hybrid":return new OpenLayers.Layer.VirtualEarth(a.NAME,d);case "SlippyMap W2GI":case "OpenStreetMap TMS":d.map&&(d.layername=d.map,delete d.map);b={type:"png",serviceVersion:"1.0.0",gutter:0,buffer:0,isInit:!0,mapExtent:this.map&&this.map.getExtent&&this.map.getExtent(),eventListeners:{loadend:function(){if(this.isInit&&
!ace.table.data[this.map.smap.locator.panelID])if(this.map.options.center){var a,b,c,d;d=this.map.options.center;a=d.lon;b=d.lat;"EPSG:900913"!==(-180<=a&&180>=a&&-90<=b&&90>=b?"EPSG:4326":"EPSG:900913")&&d.transform(new OpenLayers.Projection("EPSG:4326"),this.projection);void 0!==typeof this.map.options.zoom&&parseInt(this.map.options.zoom,10)&&(c=this.map.options.zoom);this.map.setCenter(this.map.options.center,c)}else this.map.setCenter(new OpenLayers.LonLat(-1.0971125809451124E7,4838326.814366363),
3);this.isInit=!1}},zoomToMaxExtent:!1,isBaseLayer:!0,transitionEffect:"resize",singleTile:!1,tileOrigin:new OpenLayers.LonLat(-2E7,-2E7),resolutions:[39135.75848201023,39135.75848201023,19567.87924100512,9783.93962050256,4891.96981025128,2445.98490512564,1222.99245256282,611.49622628141,305.7481131407048,152.8740565703525,76.43702828517624,38.21851414258813,19.10925707129406,9.554628535647032,4.777314267823516,2.388657133911758],zoomOffset:0,units:"m",displayProjection:new OpenLayers.Projection("EPSG:4326"),
maxExtent:new OpenLayers.Bounds(-2E7,-2E7,2E7,2E7),projection:new OpenLayers.Projection("EPSG:900913"),sphericalMercator:!0,appkey:ace.xml.getXMLData("appkey")};Object.extend(d,b);for(var b=$w(a.IMAGEURL.gsub(","," ")),e=0;e<b.length;e++)-1===b[e].indexOf("/",b[e].length-1)&&(b[e]+="/");return new OpenLayers.Layer.TMS(a.NAME,b,d);case "OpenStreetMap XYZ":b=$w(a.IMAGEURL.gsub(","," "));for(e=0;e<b.length;e++)b[e]+=d.layername+"/${z}/${x}/${y}.png";d.map=null;return new OpenLayers.Layer.XYZ(a.NAME,
b,{sphericalMercator:!0});default:throw Error(a.NAME+" - missing handler in Smap.js: _getLayers()");}})},_addCopyright:function(a){var c=(new Element("div",{id:"w2gi_copyright"})).update("&#169; "+(new Date).getFullYear()+" Where 2 Get It, Inc."),b=(new Element("div",{id:"navteq_copyright",style:"display: none;"})).update("&#169; "+(new Date).getFullYear()+" NAVTEQ Corp."),d=(new Element("div",{id:"osm_copyright",style:"display: none; left: 3px; bottom: 16px; position: relative; font: bold 12px arial; text-decoration: none; background: transparent; z-index: 999;"})).update("&#169; OpenStreetMap contributors");
a.appendChild(c);a.appendChild(b);a.appendChild(d);this.map.baseLayer&&"SlippyMap Navteq"==this.map.baseLayer.name?(b.show(),$("navteqfooter")&&$("navteqfooter").show()):$("navteqfooter")&&$("navteqfooter").hide();this.map.baseLayer&&"SlippyMap W2GI"==this.map.baseLayer.name?(d.show(),$("osmfooter")&&$("osmfooter").show()):$("osmfooter")&&$("osmfooter").hide()},_trackZoom:function(){document.fire("w2gi:track",{action:"mapzoom",value:this.map.zoom})},_trackPan:function(){document.fire("w2gi:track",
{action:"mappan",value:this.map.center.toShortString()})},_addAjaxActivityIndicator:function(a){if(!$("ajax_activity")){var c=new Element("img",{id:"ajax_activity",style:"display: none;",src:"/w2gi/images/indicator.gif"});a.appendChild(c)}},_isVectorLayerSupported:function(){return!!OpenLayers.Renderer.SVG.prototype.supported()||!!OpenLayers.Renderer.VML.prototype.supported()}});
SlippyMap.Search=Class.create({locator:null,smap:null,searchForm:null,altSearchForm:null,initialize:function(a){this.locator=a;this.smap=a.smap;this._addSearchObservers();ace.util.loadLocale()},destroy:function(){this.searchForm=this.altSearchForm=null},setBaseLayer:function(a){return this.smap.map.baseLayer.name!=a?(this.smap.map.setBaseLayer(this.layer),!0):!1},_addSearchObservers:function(){if(this.searchForm){this.searchForm.getInputs("text","addressline").each(function(a){Event.observe(a,"keypress",
function(c){c.keyCode==Event.KEY_RETURN&&(c.stop(),this._search(a.form),(c=$$(".pl_hide"))&&c.each(function(a){a.hide()}))}.bind(this))}.bind(this));var a=this.searchForm.getInputs("submit");0==a.size()&&(a=this.searchForm.select("#locator_submit"));0==a.size()&&(a=this.searchForm.select("#directions_submit"));0==a.size()&&(a=this.searchForm.select("#getlist_submit"));0!=a.size()&&(a=a[0],Event.observe(a,"click",function(b){b.stop();this._search(a.form)}.bind(this)));var c=ace.util.select(this.searchForm,
"search_toggle");0<c.length&&(c=c[0],Event.observe(c,"click",function(a){a.stop();this.searchForm.hide();this.altSearchForm&&(this.altSearchForm.show(),Form.focusFirstElement(this.altSearchForm))}.bind(this)))}},_validateSearchForm:function(a){var c=this.locator.blankAddress?!0:!1;return!a?!0:!this._checkAddresses(a.addressline)?!1:!c&&!SlippyMap.Util.isSearchFormValid(a)?(a=custom_ob&&custom_ob.localeSwitch&&custom_ob.localeSwitch("validate_form")?custom_ob.localeSwitch("validate_form"):"Please enter an address.",
ace.util.alert(a,{width:250,height:100}),!1):!0},_checkAddresses:function(a){var c=!0;if(!a)return!0;if(a.length){i=a.length;var b;for(i;0<i;i--){b=a[i-1];var d="",d=!b.include&&b.value?b.value:b;this._illegalStringCheck(d)||(c=!1)}}else b=a.value,d=!b.include&&b.value?b.value:b,this._illegalStringCheck(d)||(c=!1);return c},_illegalStringCheck:function(a){return a&&a.gsub&&a.gsub(/[!\$%\\^*()]/,"")!=a?(a=custom_ob&&custom_ob.localeSwitch&&custom_ob.localeSwitch("illegal_string")?custom_ob.localeSwitch("illegal_string"):
"Your search must not include !$%^*\\()",ace.util.alert(a),!1):!0},_addMapUrlImage:function(a){var c=$("map_url_image");if(a&&c){var b=a.match(/size=(\d+),(\d+)/);b&&(c.width=b[1],c.height=b[2]);Prototype.Browser.IE6&&(a=a.replace(/ /g,"%20"));Prototype.Browser.IE&&(a+="like="+Math.random()+"");c.src=a}},_customLayer:function(a){var c=custom.layerSwitchingRules,b,d=!1,e=!1,f;for(f in c){b=!0;for(var j in c[f])if(d=c[f][j],Object.isArray(d)?b=b&&ace.util.evalExpression(a[j.toUpperCase()],d[1],d[0]):
"layer"==j&&(e=c[f][j]),d=b,!b)break;if(d)return e}return!1}});if(!Custom)var Custom=Class.create();if(!custom_ob)var custom_ob=null;Custom.prototype={initialize:function(a){this.active_ob=null;custom_ob&&custom_ob.name&&"string"==typeof custom_ob.name?this.active_ob=new Custom[custom_ob.name](a):custom_ob&&custom_ob.name&&(this.active_ob=[],custom_ob.name.each(function(c){this.active_ob.push(new Custom[c](a))}.bind(this)))},VERSION_NUMBER:".3"};
SlippyMap.Search.ProximitySearch=Class.create(SlippyMap.Search,{cacheResults:!1,searchRadius:null,dragStartCenter:null,centerPoint:null,layer:null,nozoom:!1,firsttime:!0,gpsopt:!1,initialize:function(a){this.locator=a;var c=null;this.xmlId=this.locator.formdataid?this.locator.formdataid:$("locator_search")?"locatorsearch":"productsearch";this.searchForm=c=$("locator_search")?$("locator_search"):$("product_search")?$("product_search"):$("getlist_search");this.altSearchForm=$("driving_directions");
this.searchedLonLat=!1;SlippyMap.Search.prototype.initialize.apply(this,arguments);this._addListSearchObservers();this.searchRadius=this._getSearchRadius(this.searchForm);this.cacheResults=!this.smap.findControl("OpenLayers.Control.LocationManager");a.dynamicSearch&&(this.smap.map.events.registerPriority("mousedown",this,this._onMapMouseDown),this.smap.map.events.register("mouseup",this,this._onMapMouseUp));this._addPanelObserver(this.smap.locator.panel);this.locator.dynamicSearchForm&&this._addSearchFormObserver(this.searchForm);
a.pl_header&&""!=a.pl_header?this._observeHeader(a.pl_header):null;this.locator.panel.observe("w2gi:sliceUpdated",function(a){a.stop();this._processSlice(a.memo)}.bind(this));this.layer=this.smap.map.layers.find(function(a){return"SlippyMap W2GI"==a.name});$("search_country")&&(c="",this.locator.COUNTRY&&(c=this.locator.COUNTRY),$("search_country").options&&0==$("search_country").options.length?ace.collection.updateOptions("search_country","Country",c,function(){$("search_country").insert({top:(new Element("option",
{value:""})).update("All")});$("search_country").selectedIndex=0}):this.locator.COUNTRY&&($("country").value&&$("search_country").value!=this.locator.COUNTRY)&&($("search_country").value=this.locator.COUNTRY));document.observe("w2gi:mapFormSearch",function(a){a.stop();this.locator.proximitySearch&&this._search(this.searchForm)}.bind(this))},destroy:function(){this.locator.dynamicSearch&&(this.smap.map.events.unregister("mousedown",this,this._onMapMouseDown),this.smap.map.events.unregister("mouseup",
this,this._onMapMouseUp));this.centerPoint=this.dragStartCenter=this.searchRadius=this.cacheResults=null;SlippyMap.Search.prototype.destroy.apply(this,arguments)},search:function(a,c){this.dynamicSearch=(c="undefined"==typeof c||!c?{}:c)&&c.dynamicSearch?!0:!1;this.geoip=c&&c.geoip&&!0==c.geoip?!0:!1;if(c&&c.gps&&"first"==c.gps)this.searchGPS(a,c);else{var b={onHistory:SlippyMap.Util.addHistory,alertError:c.alertError?c.alertError:this.locator.alertError,onError:function(b){var c=b.getElementsByTagName("response")[0].getAttribute("code");
document.fire("w2gi:proximitySearchError",{xml:b});this.locator.gps&&geo_position_js&&geo_position_js.init()&&this.geoip&&4018==c?geo_position_js.getCurrentPosition(function(a){obj=new OpenLayers.LonLat(a.coords.longitude,a.coords.latitude);this.searchLonLat(obj,{dynamicSearch:this.locator.dynamicSearch})}.bind(this),function(){}.bind(this),{maximumAge:0}):1!=c&&this.locator.whereamiDiv&&null!=this.locator.whereamiDiv&&this._updateLocation({});a.longitude="";a.latitude=""}.bind(this)};Object.extend(b,
c||{});this.locator.extraOps&&Object.extend(b,this.locator.extraOps);"undefined"==typeof ace.cgeo&&this.searchedLonLat&&(a.addressline="",a.city="",a.postalcode="",a.state="",a.province="",a.address1="");ace.table.update(this.locator.panelID,a,this._processResponse.bind(this),b)}},_addListSearchObservers:function(){var a=$("getlist_search");if(a){a.getInputs().each(function(a){Event.observe(a,"keypress",function(c){c.keyCode==Event.KEY_RETURN&&(c.stop(),this.search(a.form))}.bind(this))}.bind(this));
var c=a.getInputs("submit");0==c.size()&&(c=a.select("#getlist_search"));0!=c.size()&&(c=c[0],Event.observe(c,"click",function(a){a.stop();this.search(c.form)}.bind(this)))}},_observeHeader:function(a){$(a).observe("click",function(a){var b="";a.target&&(b=$(a.target).readAttribute("action"));switch(b){case "toggle_loc_search":a=630,3<parseInt(navigator.appVersion)&&("Netscape"==navigator.appName&&(a=window.innerWidth,winH=window.innerHeight),-1!=navigator.appName.indexOf("Microsoft")&&(a=document.body.offsetWidth,
winH=document.body.offsetHeight)),b=$("search_bar").getStyle("width"),b=1*b.substr(0,b.length-2),a=(a-b)/2,0<a&&$("search_bar").setStyle({left:a+"px"}),$("search_bar").toggle()}}.bind(this))},_addSearchFormObserver:function(a){a&&(Event.observe(a,"click",function(a){var b=a.element().tagName.toLowerCase(),d=a.element().readAttribute("type");a.element().readAttribute("name");var e=a.element().readAttribute("dynamic");if(e&&""!=e&&0!=e)switch(b){case "input":a.element().readAttribute("recnum");a=this.searchForm.getInputs("text",
"addressline")[0];b={};if(a||null!=a)b={addressline:a.value};Object.extend(b,this.locator.url_params.prox);this.searchForm&&Object.extend(b,this.searchForm.serialize(!0));("checkbox"==d||"radio"==d)&&this.search(b,{formdataID:this.xmlId})}}.bind(this)),a.select("select").each(function(a){var b=a.readAttribute("dynamic");b&&(""!=b&&0!=b)&&Event.observe(a,"change",function(a){var b=a.element().tagName.toLowerCase();a.element().readAttribute("type");a.element().readAttribute("name");switch(b){case "option":case "select":a.element().readAttribute("recnum");
a=this.searchForm.getInputs("text","addressline")[0];b={};if(a||null!=a)b={addressline:a.value};Object.extend(b,this.locator.url_params.prox);this.searchForm&&Object.extend(b,this.searchForm.serialize(!0));this.search(b,{formdataID:this.xmlId})}}.bind(this))}.bind(this)))},_addPanelObserver:function(a){Event.observe(a,"click",function(a){a.target.type&&"checkbox"==a.target.type||a.stop();if(this.searchForm.visible()){var b=a.element().readAttribute("action");if(b){var d=b.lastIndexOf("/");-1!=d&&
(b=b.substring(d+1,b.length))}switch(b){case "search_address":a=a.element().readAttribute("recnum");a=ace.table.getRecord(a,this.locator.panelID);if((b=this.searchForm.getInputs("text","addressline")[0])||null!=b)b.value=(a.ADDRESS1?a.ADDRESS1+", ":"")+(a.CITY?a.CITY+",":"")+(a.STATE?" "+a.STATE:"")+(a.PROVINCE?" "+a.PROVINCE:"")+(a.POSTALCODE?" "+a.POSTALCODE:"");a={latitude:a.LATITUDE,longitude:a.LONGITUDE,country:a.COUNTRY};Object.extend(a,this.locator.url_params.prox);this.searchForm&&Object.extend(a,
this.searchForm.serialize(!0));this.search(a,{formdataID:this.xmlId});break;case "map_view":$(this.locator.mapID).toggle()}}}.bind(this))},_search:function(a,c){if(!Object.isElement(a)||this._validateSearchForm(a)){this.searchRadius=this._getSearchRadius(a);var b=this._getNoChecks(a),d=this.locatorType&&"product"==this.locatorType?this.locator.url_params.prod:this.locator.url_params.prox,e=a.serialize(!0);Object.extend(d,e);this.locator.searchLimit&&0<this.locator.searchLimit&&Object.extend(d,{limit:this.locator.searchLimit});
e={formdataID:this.locator.formdataid,alertError:this.locator.alertError};Object.extend(e,c);this.locator.like&&Object.extend(e,{like:this.locator.like});Object.extend(d,b);this.nozoom=this.searchedLonLat=!1;this.search(d,e)}},_getNoChecks:function(a){var c={};a.getInputs("checkbox").each(function(a){a.checked||(c[a.name]="")}.bind(this));return c},_onMapMouseDown:function(){this.searchRadius||(this.searchRadius=this._getSearchRadius(this.searchForm));if(!this.dragStartCenter){var a=(this.smap.map.center?
this.smap.map.center:this.smap.map.getCenter()).clone();"EPSG:900913"==this.smap.map.baseLayer.projection.toString()&&a.transform(this.smap.map.baseLayer.projection,new OpenLayers.Projection("EPSG:4326"));this.dragStartCenter=a}},_onMapMouseUp:function(){if(!(0<this.smap.routeMarkerLayer.layer.markers.length)&&this.dragStartCenter){var a=(this.smap.map.center?this.smap.map.center:this.smap.map.getCenter()).clone();"EPSG:900913"==this.smap.map.baseLayer.projection.toString()&&a.transform(this.smap.map.baseLayer.projection,
new OpenLayers.Projection("EPSG:4326"));var c=69.04*Math.max(Math.abs(a.lon-this.dragStartCenter.lon),Math.abs(a.lat-this.dragStartCenter.lat)),b=this._mapBoundsRadius()/10;c>b&&(this.searchLonLat(a,{onError:this.locator.clearLocator.bind(this.locator),alertError:!1}),this.dragStartCenter=null)}},searchLonLat:function(a,c){var b;this.locator.noZoomOnPan?(this.nozoom=!0,b=this._mapBoundsRadius()):(this.nozoom=!1,b=this.searchRadius);var d={longitude:a.lon,latitude:a.lat};this.searchForm&&Object.extend(d,
this.searchForm.serialize(!0));d.searchradius=b;Object.extend(d,this.locator.url_params.prox);""==d.longitude&&""==d.latitude&&Object.extend(d,{longitude:a.lon,latitude:a.lat});b=Object.extend({formdataID:this.xmlId,dynamicSearch:!0},c||{});this.searchedLonLat=!0;this.search(d,b)},searchGPS:function(a,c){this.gpsopt=!0;geo_position_js&&geo_position_js.init()?(this.searchForm.addressline.value="",geo_position_js.getCurrentPosition(function(a){Object.extend(c,{gps:!0});obj=new OpenLayers.LonLat(a.coords.longitude,
a.coords.latitude);this.searchLonLat(obj,c)}.bind(this),function(){Object.extend(c,{gps:!1});this.search(a,c)}.bind(this),{maximumAge:0})):(Object.extend(c,{gps:!1}),this.search(a,c))},_mapBoundsRadius:function(){var a=this.smap.map.calculateBounds();a?("EPSG:900913"==this.smap.map.baseLayer.projection.toString()&&a.transform(this.smap.map.baseLayer.projection,new OpenLayers.Projection("EPSG:4326")),a=""+69.04*Math.max(Math.abs(a.top-a.bottom),Math.abs(a.left-a.right))/2):a=this.searchRadius.replace(/\|.*/,
"");return""+a},_getSearchRadius:function(a){if(a.searchradius&&this.searchRadius)return a.searchradius.value;if(a=ace.xml.getNodeValue(ace.xml.getXML(a)[0].getElementsByTagName("searchradius")[0]))return a;a=this.smap.map.calculateBounds();if(!a)return null;"EPSG:900913"==this.smap.map.baseLayer.projection.toString()&&a.transform(this.smap.map.baseLayer.projection,new OpenLayers.Projection("EPSG:4326"));return""+69.04*Math.min(Math.abs(a.top-a.bottom),Math.abs(a.left-a.right))/2},_processResponse:function(a){var c=
ace.xml.getCollectionName(a);a.getElementsByTagName("collection")[0].getAttribute("addressline");var b=a.getElementsByTagName("collection")[0].getAttribute("address"),d=a.getElementsByTagName("collection")[0].getAttribute("country"),e=a.getElementsByTagName("collection")[0].getAttribute("city"),f=a.getElementsByTagName("collection")[0].getAttribute("postalcode"),j=a.getElementsByTagName("collection")[0].getAttribute("state"),h=a.getElementsByTagName("collection")[0].getAttribute("province"),k=a.getElementsByTagName("collection")[0].getAttribute("mapurl"),
g=$("geoip_state");g&&("start"==g.value?g.setAttribute("value","1"):g.setAttribute("value","0"));g=$(this.locator.panelID).select(".sortorder");0<g.length&&g.each(function(a){a=a.select("select")[0];$("order")&&(a.value=$F("order"));a&&"select"==a.tagName.toLowerCase()&&Event.observe(a,"change",function(a){var b=$F(a.target),a=a.target.options[a.target.selectedIndex].readAttribute("field_type");ace.table.sortCurrRecords(b,a||"",this.locator.panelID);b=0;this.centerPoint&&(b=this.centerPoint.clone());
this.smap.clear();this.smap.proximityLayer.update(b)}.bind(this))}.bind(this));g={COUNTRY:d||null,CITY:e||null,POSTALCODE:f||null,PROVINCE:h||null,STATE:j||null};document.fire("w2gi:proximityresponse",{responseXML:a,geoipData:g});Object.extend(this.locator,g||{});this.smap.clear();this._updateLayer(a);switch(c){case "poi":this.centerPoint=this._getCenterPoint(a);this.locator.defaultLocation&&(this.locator.defaultLocation=!1,this.locator.uid="");for(var l=(a=ace.util.getCookie("clientkey"))?a.split("|"):
[],m=0;m<l.length;m++)if((a=ace.table.data[this.locator.panelID].records.find(function(a){return a.CLIENTKEY==l[m]}.bind(this)))&&$(a.UID))$(a.UID).checked=!0;a=0;this.centerPoint&&(a=this.centerPoint.clone());this.firsttime&&(this.nozoom&&this.gpsopt)&&(this.smap.zoomToPOIs(),this.firsttime=!1);this.nozoom||(this.smap.zoomToPOIs(),this.locator.moreInfoZoomLevel&&this.smap.map.zoomTo(this.locator.moreInfoZoomLevel));this.nozoom=!1;this.smap.proximityLayer.update(a);break;case "multiple_address":break;
default:throw Error("Can't process collection: "+c);}this.searchedLonLat&&(b={ADDRESS1:b||null,COUNTRY:d||null,CITY:e||null,POSTALCODE:f||null,PROVINCE:h||null,STATE:j||null},"undefined"==typeof ace.cgeo&&(this.searchForm.addressline?this.searchForm.addressline.value=SlippyMap.Util.getAddressline(b):(d=$H(b).toQueryString(),Form.deserialize(this.searchForm,d))),this.locator.whereamiDiv&&null!=this.locator.whereamiDiv&&this._updateLocation(b));this.locator.updateEtailersIframe&&(null!=this.locator.updateEtailersIframe&&
$(this.locator.updateEtailersIframe))&&this._updateEtailerIframe(g);this.locator.whereamiDiv&&null!=this.locator.whereamiDiv&&!this.searchedLonLat?this._updateLocation(g):this.searchedLonLat=!1;if((this.geoip||this.gps)&&this.searchForm.addressline)b=[],null!=e&&0<e.length&&b.push(e),null!=j&&0<j.length&&b.push(j),null!=h&&0<h.length&&b.push(h),null!=f&&0<f.length&&b.push(f),e=b.join(" "),this.searchForm.addressline.value=e;this.locator.location_address_id&&""!=this.locator.location_address_id&&(e=
collection[0],f=e.ADDRESS1+" "+e.CITY+" "+e.STATE+" "+e.POSTALCODE,$(this.locator.location_address_id).value=f,$("location_country")&&($("location_country").value=e.COUNTRY),$("location_lat")&&($("location_lat").value=e.LATITUDE),$("location_long")&&($("location_long").value=e.LONGITUDE));$("search_country")&&g.COUNTRY&&($("search_country").value=g.COUNTRY);k&&this._addMapUrlImage(k);this.locator._setURLParams(!0);this.searchedLonLat=!1;return this.cacheResults},_updateLayer:function(a){var a=$A(ace.xml.parse(a)),
c=!1,b="";if(!("undefined"==typeof custom||null===custom)&&custom.layerSwitchingRules)a.any(function(a){return b=this._customLayer(a)}.bind(this))&&(c=!0);this.layer=null;var d=this.smap.map.layers.find(function(a){return"Proximity markers"==a.name});c&&b&&(this.layer=this.smap.map.layers.find(function(a){return a.name==b}));if((!c||!this.layer)&&a.any(function(a){return"US"!=a.COUNTRY&&"CA"!=a.COUNTRY&&"MX"!=a.COUNTRY&&0<a.COUNTRY.length}))this.layer=this.smap.map.layers.find(function(a){return"Google Normal"==
a.name});this.layer||(a.any(function(a){return"US"==a.COUNTRY||"CA"==a.COUNTRY||"MX"==a.COUNTRY})&&(this.layer=this.smap.map.layers.find(function(a){return"SlippyMap W2GI"==a.name})),this.layer||(this.layer=this.smap.map.baseLayer),this.layer||(this.layer=this.smap.map.layers.find(function(a){return"SlippyMap"!=a.name.gsub(0,8)})));d.projection=this.layer.projection;d.maxExtent=this.layer.maxExtent;d.units=this.layer.units;d.maxResolution=this.layer.maxResolution;this.layer&&this.smap.map.setBaseLayer(this.layer)},
_updateEtailerIframe:function(a){if(a.COUNTRY){var c=$(this.locator.updateEtailersIframe);c.src=c.src.substr(0,c.src.length-2)+a.COUNTRY}},_updateLocation:function(a){!a.COUNTRY&&!a.STATE&&!a.PROVINCE&&!a.CITY&&!a.POSTALCODE?ace.template.updateLocation(this.locator.whereamiDiv,"location_none",a):a.CITY?ace.template.updateLocation(this.locator.whereamiDiv,"location_us",a):ace.template.updateLocation(this.locator.whereamiDiv,"location_nc",a)},_getCenterPoint:function(a){return(a=(ace.xml.getCollection(a,
"poi")||ace.xml.getCollection(a,"multiple_address")).getAttribute("centerpoint"))?OpenLayers.LonLat.fromString(a):0},_processSlice:function(a){a=this.smap.getPOIBounds(a);0==this.locator.proximitySearch.centerPoint&&(this.locator.proximitySearch.centerPoint=OpenLayers.LonLat.fromString((a.left-a.right)/2+a.right+","+((a.top-a.bottom)/2+a.bottom)));var c=this.locator.proximitySearch.centerPoint.clone(),b=this.locator.proximitySearch.centerPoint.clone();"EPSG:900913"==this.smap.map.baseLayer.projection.toString()&&
"EPSG:4326"===SlippyMap.Util.guessProjection(c)&&c.transform(new OpenLayers.Projection("EPSG:4326"),this.smap.map.baseLayer.projection);a.extend(c);a=this.smap.padBounds(a);(!this.smap.map.calculateBounds().containsBounds(a)||this.locator.zoomToBounds)&&this.smap.map.zoomToExtent(a);this.smap.clear();this.smap.proximityLayer.update(b)},_makeDefaultLocation:function(a,c){var b=this.locator.clientCookie&&this.locator.clientCookie.name?this.locator.clientCookie.name:"mylocation",d=this.locator.clientCookie&&
this.locator.clientCookie.domain?this.locator.clientCookie.domain:"",e="",f="undefined"!=typeof this.locator.clientCookie.cookieLimit&&0<this.locator.clientCookie.cookieLimit?this.locator.clientCookie.cookieLimit:1,j=ace.util.getCookie(b),h=[],j=j?j.split("|"):[];a.checked="undefined"!=typeof a.type&&"checkbox"==a.type?a.checked:!0;if(this.locator.clientCookie&&this.locator.clientCookie.value){var k=ace.table.data[this.locator.panelID].records.find(function(a){return a.UID==c}.bind(this));k&&(e=k[this.locator.clientCookie.value.toUpperCase()])}if(1==
f)h=[];else for(k=0;k<j.length;k++){if(j[k]==e&&a.checked)return;0<j[k].strip().length&&h.push(j[k])}if(a.checked)if(1<f&&h.length>=f){d={width:425,height:120};if((d=$("cookielimitmsg"))&&d.innerHTML)var b=d.innerHTML,g=d.readAttribute("params"),d={params:g};else b="You already have the maximum number of favorite locations.  Please remove some and try again";ace.util.alert(b,g);a.checked=!1}else h.push(e),g=h.join("|"),ace.util.setCookie(b,g,1E3,null,d,0),$("cookieaddmsg")&&0<$("cookieaddmsg").innerHTML.strip().length&&
(d={width:425,height:120},b=$("cookieaddmsg").innerHTML,(g=$("cookieaddmsg").readAttribute("params"))&&0<g.strip().length&&(d={params:g}),ace.util.alert(b,d));else{for(k=0;k<h.length;k++)h[k]==e&&h.splice(k,1);g=h.length?h.join("|"):"";ace.util.setCookie(b,g,1E3,null,d,0)}1==f&&$$(".make_default_loc").each(function(a){var b=a.getAttribute("uid");"#{UID}"!=b&&b!=c&&(a.checked=!1)}.bind(this))}});
SlippyMap.Search.ProximitySearch.Product=Class.create(SlippyMap.Search.ProximitySearch,{cacheResults:!1,searchRadius:null,dragStartCenter:null,centerPoint:null,layer:null,initialize:function(a){this.locator=a;this.searchForm=$("product_search");this.altSearchForm=$("driving_directions");a.locatorType&&"product"==a.locatorType&&SlippyMap.Search.ProximitySearch.prototype.initialize.apply(this,arguments);a.onlinePanel&&""!=a.onlinePanel&&this._fillOnlinePanel();a.onlineStores&&""!=a.onlineStores&&this._fillOnlineStores()},
destroy:function(){SlippyMap.Search.ProximitySearch.prototype.destroy.apply(this,arguments);this.centerPoint=this.dragStartCenter=this.cacheResults=null},search:function(a,c){SlippyMap.Search.ProximitySearch.prototype.search.apply(this,arguments)},_fillOnlineStores:function(){var a=this.locator.url_params.etail;a.currency||(a.currency="auto");ace.table.update(this.locator.onlineStores,a,null,{formdataID:"onlinestoresearch",like:1,alertError:!1})},_fillOnlinePanel:function(){var a=this.locator.url_params.etail;
a.currency||(a.currency="auto");var c={formdataID:"onlineetailersearch",like:1,alertError:!1,onError:this._prodError.bind(this)};this.locator.synchronous&&Object.extend(c,{asynchronous:!1});ace.table.update("online_comp_panel",a,this._processProducts.bind(this),c)},_processProducts:function(a){document.fire("w2gi:onlineProductSearch",{responseXML:a})},_prodError:function(a){document.fire("w2gi:onlineProductSearch",{responseXML:a});document.fire("w2gi:onlineProductError",{responseXML:a})},_search:function(a){SlippyMap.Search.ProximitySearch.prototype._search.apply(this,
arguments)}});
SlippyMap.Search.DirectionsSearch=Class.create(SlippyMap.Search,{responseXML:null,bounds:null,formData:null,layer:null,includeATW:null,mapurl:null,addresses:!1,initialize:function(a){this.locator=a;this.searchForm=$("driving_directions");this.altSearchForm=$(a.searchFormId);this.formData=ace.xml.getFormData(this.searchForm,"drivingdirections");SlippyMap.Search.prototype.initialize.apply(this,arguments);this._addReverseSearchInputsObservers();this.ddpanel=this.locator.ddpanel&&""!=this.locator.ddpanel?this.locator.ddpanel:
this.locator.panel;this._addPanelObserver(this.ddpanel);this.layer=this.smap.map.layers.find(function(a){return"SlippyMap Navteq"==a.name})},destroy:function(){SlippyMap.Search.prototype.destroy.apply(this,arguments);this.includeATW=this.bounds=null},search:function(a,c){this.searchFromBubble=this.searchFromMarker=!1;this.searchFromForm=!0;var b=Form.getInputs(a,"text","addressline"),d=Form.getInputs(a,"hidden","addressline");2==d.size()&&0==b.size()?b=d:1==d.size()&&b.push(d[0]);b=Form.serializeElements(b,
!0).addressline;b=ace.util.clean(b);d={};$("location_lat")&&$("location_long")&&$("location_action")?(this.locator.lat=$("location_lat").value,this.locator.lon=$("location_long").value,this.locator.action=$("location_action").value):$("longitude")&&($("latitude")&&$("dest_longitude")&&$("dest_latitude"))&&(b[2]={},b[2].latitude=$("latitude").value,b[2].longitude=$("longitude").value,b[2].dest_longitude=$("dest_longitude").value,b[2].dest_latitude=$("dest_latitude").value);this.locator.lat&&null!=
this.locator.lat&&this.locator.action&&null!=this.locator.action?(Object.extend(b,{latitude:this.locator.lat,longitude:this.locator.lon,action:this.locator.action}),d={uid:this.locator.uid,action:this.locator.action}):d={action:"From"};this.includeATW=Form.getInputs(a,"checkbox","includeATW")[0]&&"on"==Form.getInputs(a,"checkbox","includeATW")[0].getValue();c={onHistory:SlippyMap.Util.addHistory};ace.useClientSideDir&&(c.clientsidedirections=!0);!0===this.locator.clientsidedirections?c.clientsidedirections=
!0:!1===this.locator.clientsidedirections&&(c.clientsidedirections=!1);ace.directions.search(this.ddpanel,this.formData,this.includeATW,b,d,this.processResponse.bind(this),c,a)},bubbleSearch:function(a){a.target.type&&"checkbox"==a.target.type||a.stop();this.searchFromMarker=!1;this.searchFromBubble=!0;this.searchFromForm=!1;var c=a.element().form,b=Form.getInputs(c,"text","addressline")[0],b=ace.util.clean(b);if(!b.value.empty()){var d=a.element().readAttribute("recnum");ace.table.data[this.locator.panelID].options.attributes&&
"maneuvers"==ace.table.data[this.locator.panelID].options.attributes.NAME&&(d=ace.table.data[this.locator.panelID].records.find(function(a){return a.POINUM==d&&a.RECNUM!=d}.bind(this)).RECNUM);var a=ace.table.getRecord(d,this.locator.panelID),a=ace.util.clean(a),e=c.getElementsByTagName("a");e=e&&0<e.length?c.getElementsByTagName("a")&&"To"==c.getElementsByTagName("a")[0].innerHTML?"To":"From":(e=c.select("#linkTo","#linkFrom").detect(function(a){return a.visible()}))&&"linkFrom"==e.identify()?"To":
"From";var f=Form.serialize(c,!0),f="From"==e?[a,f]:[f,a],j={uid:a.UID,action:e};this.includeATW=Form.getInputs(c,"checkbox","includeATW")[0]&&"on"==Form.getInputs(c,"checkbox","includeATW")[0].getValue();var h={onHistory:SlippyMap.Util.addHistory};ace.useClientSideDir&&(h.clientsidedirections=!0);!0===this.locator.clientsidedirections?h.clientsidedirections=!0:!1===this.locator.clientsidedirections&&(h.clientsidedirections=!1);ace.directions.search(this.ddpanel,this.formData,this.includeATW,f,j,
this.processResponse.bind(this),h,c);this._updateSearchForm("From"==e,b.value,a)}},markerSearch:function(a,c,b){this.searchFromMarker=!0;this.searchFromForm=this.searchFromBubble=!1;var d=new OpenLayers.LonLat(a.lonlat.lon,a.lonlat.lat);"EPSG:900913"==this.smap.map.baseLayer.projection.toString()&&d.transform(this.smap.map.baseLayer.projection,new OpenLayers.Projection("EPSG:4326"));var e;a&&a.reverseGeocoderAddress?(e=a.reverseGeocoderAddress,e.LONGITUDE=d.lon,e.LATITUDE=d.lat):e={LONGITUDE:d.lon,
LATITUDE:d.lat,COUNTRY:a.country};d=$("driving_directions");b=0>=c?[e,b]:[b,e];e={onHistory:SlippyMap.Util.addHistory};ace.useClientSideDir&&(e.clientsidedirections=!0);!0===this.locator.clientsidedirections?e.clientsidedirections=!0:!1===this.locator.clientsidedirections&&(e.clientsidedirections=!1);ace.directions.search(this.ddpanel,this.formData,this.includeATW,b,!1,this.processResponse.bind(this),e,d);this._updateAddressline(a.getAddress(),c)},processResponse:function(a){this.smap.clear();$("getlist_search")&&
$("getlist_search").hide();this.searchForm.visible()||(this.altSearchForm.hide(),this.searchForm.show(),$("findlocation")&&($("drivedirections")&&($("findlocation").hasClassName("active")||$("drivedirections").hasClassName("active")))&&$("findlocation","drivedirections").invoke("toggleClassName","active"),$("loc")&&($("dd")&&($("loc").hasClassName("current")||$("dd").hasClassName("current")))&&$("loc","dd").invoke("toggleClassName","current"));var c=this.smap.map.layers.find(function(a){return"Route markers"==
a.name}),b=this.smap.map.layers.find(function(a){return"Route vector"==a.name});b||(b=this.smap.map.layers.find(function(a){return"Route image"==a.name}));if("maneuvers"==a.attributes.NAME){this.bounds=this._getRouteBounds(a.attributes);var d=a.addresses;this.addresses=d;this.mapurl=a.attributes.MAPURL;["A","B"].each(function(a,b){d[b].POINUM=a;d[b].RECNUM=a});if("EPSG:4326"==this.smap.map.baseLayer.projection.toString()){if(this.layer=this.smap.map.layers.find(function(a){return"SlippyMap Navteq"==
a.name}),b.projection=new OpenLayers.Projection("EPSG:4326"),b.maxExtent=new OpenLayers.Bounds(-165,15,-50,75),b.units="degrees",b.maxResolution=1.40625,c.projection=new OpenLayers.Projection("EPSG:4326"),c.maxExtent=new OpenLayers.Bounds(-165,15,-50,75),c.units="degrees",c.maxResolution=1.40625,d.any(function(a){return"US"!=a.COUNTRY&&"CA"!=a.COUNTRY})||"Google"==a.source){var e=this.smap.map.layers.find(function(a){return"Google Normal"==a.name||"Google Streets"==a.name});!e&&"Google"==a.source&&
(e=new OpenLayers.Layer.Google("Google Streets",{projection:"EPSG:900913",units:"m",maxExtent:new OpenLayers.Bounds(-2.003750834E7,-2.003750834E7,2.003750834E7,2.003750834E7),maxZoomLevel:18,sphericalMercator:!0,maxResolution:156543.0339}),this.smap.map.addLayer(e));this.layer=e;b.projection=new OpenLayers.Projection("EPSG:900913");b.maxExtent=new OpenLayers.Bounds(-2.003750834E7,-2.003750834E7,2.003750834E7,2.003750834E7);b.units="m";b.maxResolution=156543.0339;c.projection=new OpenLayers.Projection("EPSG:900913");
c.maxExtent=new OpenLayers.Bounds(-2.003750834E7,-2.003750834E7,2.003750834E7,2.003750834E7);c.units="m";c.maxResolution=156543.0339;this.bounds.transform(new OpenLayers.Projection("EPSG:4326"),new OpenLayers.Projection("EPSG:900913"))}}else navteqLayer=this.smap.map.layers.find(function(a){return"SlippyMap Navteq"==a.name}),d.any(function(a){return"US"==a.COUNTRY||"CA"==a.COUNTRY})&&navteqLayer?(this.layer=navteqLayer,b.projection=new OpenLayers.Projection("EPSG:4326"),b.maxExtent=new OpenLayers.Bounds(-165,
15,-50,75),b.units="degrees",b.maxResolution=1.40625,c.projection=new OpenLayers.Projection("EPSG:4326"),c.maxExtent=new OpenLayers.Bounds(-165,15,-50,75),c.units="degrees",c.maxResolution=1.40625):(this.layer=this.smap.map.baseLayer,"SlippyMap"==this.layer.name.gsub(0,8)&&(this.layer=this.smap.map.layers.find(function(a){return"Google Normal"==a.name||"Google Streets"==a.name})),b.projection=new OpenLayers.Projection("EPSG:900913"),b.maxExtent=new OpenLayers.Bounds(-2.003750834E7,-2.003750834E7,
2.003750834E7,2.003750834E7),b.units="m",b.maxResolution=156543.0339,c.projection=new OpenLayers.Projection("EPSG:900913"),c.maxExtent=new OpenLayers.Bounds(-2.003750834E7,-2.003750834E7,2.003750834E7,2.003750834E7),c.units="m",c.maxResolution=156543.0339,this.bounds.transform(new OpenLayers.Projection("EPSG:4326"),new OpenLayers.Projection("EPSG:900913")));this.smap.map.setBaseLayer(this.layer);this.smap.map.zoomToExtent(this.smap.padBounds(this.bounds));this._updateCountrySelects(d);this.smap.routeMarkerLayer.addEndMarkers(d);
this.smap.routeLayer.addRoute();a.pois&&(c=a.pois,c.each(function(a,b){a.POINUM=b+1;a.RECNUM=ace.table.data[this.locator.panelID].records.length+1;ace.table.data[this.locator.panelID].records.push(a)}.bind(this)),b=this.ddpanel.down(),this._addAlongTheWayInfo(b,c));this._addReverseSearchObservers();this._updatePanelAddressline(d);this.mapurl&&this._addMapUrlImage(this.mapurl)}else this.smap.routeLayer.clear(),this.smap.routeMarkerLayer.clear(),d=this.addresses=a.addresses,this._updateCountrySelects(d);
document.fire("w2gi:directionsResponse",{response:a,searchFromForm:this.searchFromForm,searchFromBubble:this.searchFromBubble,searchFromMarker:this.searchFromMarker});return!0},_addAlongTheWayInfo:function(a,c){this.smap.proximityLayer.addPOIMarkers(c,!1);var b=this._getManeuverPOIs(c);this._updatePanel(a,b)},_getManeuverPOIs:function(a){for(var c={},b=0,d=a.length;b<d;b++){var e=a[b];c[e.MANEUVER]?c[e.MANEUVER].push(e):c[e.MANEUVER]=[e]}return c},_updatePanel:function(a,c){var b=ace.util.select(a,
"maneuver_pois");for(maneuver in c){var d=parseInt(maneuver)-1,e=ace.template.getTemplate("along_the_way"),a=ace.template.getTableTemplate(e,c[maneuver]);b[d].update(a).show()}},_updateCountrySelects:function(a){$("orig_country")&&(a[0]&&a[0].COUNTRY)&&($("orig_country").value=a[0].COUNTRY);$("dest_country")&&(a[1]&&a[1].COUNTRY)&&($("dest_country").value=a[1].COUNTRY)},_updatePanelAddressline:function(a){var c=ace.util.select($(this.ddpanel),"addressline");if(0<c.length)for(var b=ace.util.select($(this.ddpanel),
"ddendpoint"),d=0;d<c.length;d++){if(b&&2==b.length){var e=null,e=0==d?ace.template.getTemplate("ddstarticon",{}):ace.template.getTemplate("ddendicon",{});null!=e&&b[d].update(e)}var e=$(a[d]),f=$(c[d]),j="";e.ADDRESS1&&!e.ADDRESS1.blank()?j=e.ADDRESS1.strip():e.ADDRESS&&!e.ADDRESS.blank()&&(j=e.ADDRESS);var h=f.getElementsBySelector(".address_line1");j&&0<h.length&&h[0].update(j);var h=e.CITY&&!e.CITY.blank()?e.CITY:"",k=ace.util.select(f,"address_city");h&&0<k.length&&k[0].update(h);k="";"US"!=
e.COUNTRY&&e.PROVINCE?k=e.PROVINCE:e.STATE&&(k=e.STATE);var g=ace.util.select(f,"address_state");k&&0<g.length&&g[0].update(k);var g=e.POSTALCODE&&e.POSTALCODE.empty()?"":e.POSTALCODE,l=ace.util.select(f,"address_zip");g&&0<l.length&&l[0].update(g);l=e.COUNTRY&&e.COUNTRY.empty()?"":e.COUNTRY;f=ace.util.select(f,"address_country");l&&0<f.length&&f[0].update(l);0==d&&($("latitude")&&$("longitude"))&&($("latitude").value=e.LATITUDE,$("longitude").value=e.LONGITUDE);1==d&&($("dest_latitude")&&$("dest_longitude"))&&
($("dest_latitude").value=e.LATITUDE,$("dest_longitude").value=e.LONGITUDE);0==d&&($("oaddress1")&&$("oaddress1")&&!j.blank())&&($("oaddress1").value=e.ADDRESS1);0==d&&($("oaddress2")&&$("oaddress2")&&!address2.blank())&&($("oaddress2").value=e.ADDRESS2);0==d&&($("ocity")&&$("ocity")&&!h.blank())&&($("ocity").value=e.CITY);0==d&&($("ostate")&&$("ostate")&&!k.blank())&&($("ostate").value=e.STATE);0==d&&($("oprovince")&&$("oprovince")&&e.PROVINCE&&!e.PROVINCE.blank())&&($("oprovince").value=e.PROVINCE);
0==d&&($("opostalcode")&&$("opostalcode")&&!g.blank())&&($("opostalcode").value=e.POSTALCODE);0==d&&($("ocountry")&&$("ocountry")&&e.COUNTRY&&!e.COUNTRY.blank())&&($("ocountry").value=e.COUNTRY);1==d&&($("daddress1")&&$("daddress1")&&!j.blank())&&($("daddress1").value=j);1==d&&($("daddress2")&&$("daddress2")&&!address2.blank())&&($("daddress2").value=address2);1==d&&($("dcity")&&$("dcity")&&!h.blank())&&($("dcity").value=h);1==d&&($("dstate")&&$("dstate")&&!k.blank())&&($("dostate").value=k);1==d&&
($("dprovince")&&$("dprovince")&&e.PROVINCE&&!e.PROVINCE.blank())&&($("dprovince").value=e.PROVINCE);1==d&&($("dpostalcode")&&$("dpostalcode")&&!g.blank())&&($("dpostalcode").value=g);1==d&&($("dcountry")&&$("dcountry")&&e.COUNTRY&&!e.COUNTRY.blank())&&($("dcountry").value=e.COUNTRY)}},_addPanelObserver:function(a){Event.observe(a,"click",function(c){var b=c.target.tagName;!(c.target.type&&"checkbox"==c.target.type)&&"a"!=b.toLowerCase()&&c.stop();if(this.searchForm&&this.searchForm.visible())switch(c.element().readAttribute("action")){case "search_address":var c=
c.element().readAttribute("recnum"),b=parseInt(c)-1,c=this._getMultipleAddresses(),b=c.addresses[b],d=ace.xml.parseNode(b),e=this.searchForm.getInputs("text","addressline")[c.index];e&&(e.value=this._getSelectedInput(b));ace.directions.addresses[c.index]=d;ace.directions.search(a,this.formData,this.includeATW,ace.directions.addresses,!1,this.processResponse.bind(this),{onHistory:SlippyMap.Util.addHistory});break;default:if("a"==b.toLowerCase()){b=c.element().readAttribute("href");if(c.element().hasClassName("lightwindow")){ace.util.alertExternal(c.element());
break}d=c.element().readAttribute("onclick");if(void 0==d||null==d||""==d)c.element().readAttribute("target"),"http"==b.substr(0,4)&&window.open(b)}}}.bind(this))},_search:function(a){this._validateSearchForm(a)&&this.search(a)},_updateSearchForm:function(a,c,b){var d=b.ADDRESS1+", "+b.CITY+", "+b.STATE+" "+b.POSTALCODE,e=this.searchForm.getInputs("text","addressline"),f=this.searchForm.getInputs("hidden","addressline"),j=this.searchForm.getInputs("checkbox","includeATW");j&&j[0]&&(j[0].checked=this.includeATW?
"checked":"");e[0]&&(e[0].value=a?d:c);e[1]?e[1].value=a?c:d:f[0]&&(f[0].value=a?d:c);c=this.searchForm.getInputs("hidden","uid");d=this.searchForm.getInputs("hidden","action");e=this.searchForm.getInputs("hidden","lon");f=this.searchForm.getInputs("hidden","lat");c&&0<c.size()&&(c[0].value=b.UID);d&&0<d.size()&&(d[0].value=a?"From":"To");e&&0<e.size()&&(e[0].value=b.LONGITUDE);f&&0<f.size()&&(f[0].value=b.LATITUDE)},_updateAddressline:function(a,c){var b=this.searchForm.getInputs("text","addressline")[c];
b||(b=this.searchForm.getInputs("hidden","addressline")[0]);b&&(b.value=SlippyMap.Util.getAddressline(a))},_addReverseSearchInputsObservers:function(){if(this.searchForm){var a=this.searchForm.getElementsByTagName("img")[0];a&&Event.observe(a,"click",this._reverseSearchInputs.bind(this))}},_reverseSearch:function(){this._reverseSearchInputs();ace.directions.search(this.ddpanel,this.formData,this.includeATW,this.addresses.reverse(),!1,this.processResponse.bind(this),{onHistory:SlippyMap.Util.addHistory},
this.searchForm);document.fire("w2gi:track",{action:"clickonreversedd",value:"1"})},_reverseSearchP:function(){ace.directions.search(this.ddpanel,this.formData,this.includeATW,this.addresses.reverse(),!1,this.processResponse.bind(this),{onHistory:SlippyMap.Util.addHistory},this.searchForm);document.fire("w2gi:track",{action:"clickonreversedd",value:"1"})},_reverseSearchInputs:function(){var a=this.searchForm.getInputs("text","addressline"),c=a.pluck("value").reverse();a.each(function(a,d){a.value=
c[d]})},_reverseSearchAction:function(){$("location_action")&&($("location_action").value="To"==$("location_action").value?"From":"To")},_getMultipleAddresses:function(){return this.addresses},_getAddressesFromMultiple:function(){var a=[],c=ace.xml.getCollection(this.responseXML);$A(c.getElementsByTagName("collection")[0].childNodes).each(function(b){"collection"==b.tagName&&"multiple_address"==b.getAttribute("name")?a.push(ace.xml.parseNode(b.getElementsByTagName("address")[0])):a.push(ace.xml.parseNode(b))});
return a},_getSelectedInput:function(a){var c=a.getElementsByTagName("address1")[0].firstChild,b=c?c.nodeValue:"",c=a.getElementsByTagName("state")[0].firstChild?a.getElementsByTagName("state")[0].firstChild.nodeValue:"",d=a.getElementsByTagName("province")[0].firstChild?a.getElementsByTagName("province")[0].firstChild.nodeValue:"",e=a.getElementsByTagName("postalcode")[0].firstChild?a.getElementsByTagName("postalcode")[0].firstChild.nodeValue:"",a=a.getElementsByTagName("city")[0].firstChild?a.getElementsByTagName("city")[0].firstChild.nodeValue:
"",a=(""==b?"":b+", ")+(a+", ");return a+=c+" "+d+" "+e},_addReverseSearchObservers:function(){ace.util.select(this.ddpanel,"reverse_directions").each(function(a){Event.observe(a,"click",this._reverseSearch.bind(this))}.bind(this));ace.util.select(this.ddpanel,"reverse_directions_p").each(function(a){Event.observe(a,"click",this._reverseSearchP.bind(this))}.bind(this))},_getIconAddresses:function(a){a=ace.xml.getCollection(a,"address").getElementsByTagName("address");return ace.xml.parseNodes(a)},
_getRouteBounds:function(a){return new OpenLayers.Bounds.fromString(a.BOUNDS)}});SlippyMap.Layer=Class.create({smap:null,layer:null,initialize:function(a){this.smap=a},destroy:function(){this.layer=this.smap=null}});
SlippyMap.Layer.ProximityLayer=Class.create(SlippyMap.Layer,{features:null,highlight:null,highlightEffect:null,initialize:function(a,c,b){this.locator=a.locator;b&&(this.highlight=!0==b.highlight?!0:!1,this.highlightEffect=b.highlightEffect?b.highlightEffect:!1);this.features={};this.layer=new OpenLayers.Layer.Markers(c,{projection:a.map.layers[0].projection});a.map.addLayer(this.layer);SlippyMap.Layer.prototype.initialize.apply(this,arguments);this._addPanelObserver(this.smap.locator.panel);this.smap.locator.ddpanel&&
""!=this.smap.locator.ddpanel&&this._addPanelObserver(this.smap.locator.ddpanel)},destroy:function(){SlippyMap.Layer.prototype.destroy.apply(this,arguments);this.features=null},clear:function(){this.layer.clearMarkers();for(recnum in this.features)this.features[recnum].destroy();this.features={}},update:function(a){this.addCenterMarker(a);this.addPOIMarkers()},addPOIMarkers:function(a,c){for(var a=a||ace.table.getSlice(this.locator.panelID)||ace.table.data[this.locator.panelID].records,b=a.length-
1;0<=b;b--)this.addPOIMarker(a[b],!1,c)},addPOIMarker:function(a,c,b){var d=null;c?(d=new OpenLayers.LonLat(a.LONGITUDE,a.LATITUDE),c=ace.template.getIconTemplate("dragabble_icon",a),c=new OpenLayers.Icon.IconFromTemplate(c),d=new OpenLayers.Marker.DragabbleMarker(d,c),"EPSG:900913"==this.smap.map.baseLayer.projection.toString()&&d.setSphericalMercator(!0),b||d.events.register("click",this,function(a){OpenLayers.Event.stop(a)}),d.events.register("touchend",this,function(a){OpenLayers.Event.stop(a)})):
(c=this._createFeature(a),d=c.createMarker(),this.features[a.RECNUM]=c,b||this._bindMarkerClick(d,c,a.UID));d.recnum=a.RECNUM;this.highlight&&this._bindMarkerOver(d);this.layer.addMarker(d);return d},removePOIMarker:function(a){var c=this.getPOIMarker(a);this.layer.removeMarker(c);this.features[a]&&(this.features[a].destroy(),delete this.features[a]);return c},replacePOIMarker:function(a,c){this.removePOIMarker(a);var b=ace.table.getRecord(a,this.locator.panelID),b=this.addPOIMarker(b,c);for(i in this.layer.markers){var d=
this.layer.markers[i];d&&d.icon&&(d.icon.imageDiv.style.zIndex=d.recnum==a?4500:3500)}return b},getPOIMarker:function(a){return this.layer.markers.find(function(c){return c.recnum==a})},addCenterMarker:function(a){var c=ace.template.getTemplate("center_marker");if(!c||!a)return null;c=new OpenLayers.Icon.IconFromTemplate(c);a=new OpenLayers.Marker.DragabbleMarker(a,c);"EPSG:900913"==this.smap.map.baseLayer.projection.toString()&&a.setSphericalMercator(!0);a.events.register("mouseup",this.smap.locator.proximitySearch,
function(a){OpenLayers.Event.stop(a);a=a.object.lonlat;this.smap.map.setCenter(a);"EPSG:900913"==this.smap.map.baseLayer.projection.toString()&&a.transform(this.smap.map.baseLayer.projection,new OpenLayers.Projection("EPSG:4326"));this.searchLonLat(a,{onError:this.locator.clearLocator.bind(this.locator)});document.fire("w2gi:track",{action:"centermarkerdrag",value:a.toShortString()})});a.events.register("touchend",this.smap.locator.proximitySearch,function(a){OpenLayers.Event.stop(a);a=a.object.lonlat;
this.smap.map.setCenter(a);"EPSG:900913"==this.smap.map.baseLayer.projection.toString()&&a.transform(this.smap.map.baseLayer.projection,new OpenLayers.Projection("EPSG:4326"));this.searchLonLat(a,{onError:this.locator.clearLocator.bind(this.locator)});document.fire("w2gi:track",{action:"centermarkerdrag",value:a.toShortString()})});this.layer.addMarker(a);return a},_addPanelObserver:function(a){$(a).observe("click",function(b){var c=b.target.tagName;!(b.target.type&&"checkbox"==b.target.type)&&"a"!=
c.toLowerCase()&&b.stop();var e=b.element().readAttribute("action");if(e){var f=e.lastIndexOf("/");-1!=f&&(e=e.substring(f+1,e.length))}switch(e){case "open_bubble":c=b.element().readAttribute("recnum");e=this.features[c];b=b.element().readAttribute("initialtab");!b&&(e&&e.popup)&&(b=$(e.popup.id).select(".tab_label"),b=0<b.length?b[0].innerHTML:null);this._markerClick(e,b)&&(c=ace.table.getRecord(c,this.locator.panelID),document.fire("w2gi:track",{action:"clickondealer-panel",value:c.UID}));b&&this.smap.popup.selectTabLabel(b);
break;case "sort_table":c=b.element().readAttribute("sort_field");b=b.element().readAttribute("field_type");ace.table.sortRecords(c,b,this.locator.panelID);ace.table.updateFromRecords(a);this.smap.clear();this.update(this.smap.locator.proximitySearch.centerPoint);document.fire("w2gi:track",{action:"sort_table",value:c});break;case "GSView_close":$("gboxDiv").style.display="none";$("innerGbox").style.display="none";panorama=new google.maps.StreetViewPanorama(document.getElementById("streetViewCtn"),
panoramaOptions);panorama.setVisible(!1);break;case "GSView_open":var c=b.element().readAttribute("recnum"),c=ace.table.getRecord(c,this.locator.panelID),b=parseFloat(c.LATITUDE),c=parseFloat(c.LONGITUDE),j=new google.maps.LatLng(b,c),h={heading:34,pitch:10,zoom:1};(new google.maps.StreetViewService).getPanoramaByLocation(j,50,function(a,b){b==google.maps.StreetViewStatus.OK?($("gboxDiv").style.display="block",$("innerGbox").style.display="block",new google.maps.StreetViewPanorama(document.getElementById("streetViewCtn"),
{position:j,pov:h,visible:!0})):($("gboxDiv").style.display="block",$("innerGbox").style.display="block",$("streetViewCtn").setStyle({backgroundColor:"#fff",fontsize:"large"}),new google.maps.StreetViewPanorama(document.getElementById("streetViewCtn"),{position:j,pov:h,visible:!1}),$("streetViewCtn").innerHTML="<h1>We are sorry, street view for this area is not available at this moment.</h1>")});break;case "more_info":c=b.element().readAttribute("recnum");ace.table.oldrecords=ace.table.data[this.locator.panelID].records.clone();
ace.table.selected=c;b=ace.table.data[this.locator.panelID].records.slice(c-1,c);b[0].RECNUM=1;b[0].POINUM=1;this.smap.locator.clear();ace.table.updateFromRecords(a,b,{NAME:"more_info"});this.addPOIMarker(b[0]);this.smap.zoomToPOI(b,1);document.fire("w2gi:track",{action:"more_info",value:b[0].UID});break;case "show_all":this.smap.locator.clear();ace.table.data[this.locator.panelID].records=ace.table.oldrecords.clone();ace.table.data[this.locator.panelID].records[ace.table.selected-1].RECNUM=ace.table.selected;
ace.table.data[this.locator.panelID].records[ace.table.selected-1].POINUM=ace.table.selected;ace.table.updateFromRecords(a,ace.table.data[this.locator.panelID].records,{NAME:"poi"});this.addPOIMarkers();this.smap.zoomToPOIs();break;case "make_default_loc":this.smap.locator.proximitySearch._makeDefaultLocation(b.element(),b.element().readAttribute("uid"));break;case "linktrack":b=b.element().readAttribute("linktrack");document.fire("w2gi:track",{action:"linktrack",value:b});break;default:if("a"==c.toLowerCase()){c=
b.element().readAttribute("href");if(b.element().hasClassName("lightwindow")){(c=b.element().readAttribute("url"))&&-1!=c.indexOf("emaillocatorstart")?(c=b.findElement("[recnum]"),document.fire("w2gi:emailLocation",{recnum:c&&c.getAttribute("recnum")})):c&&-1!=c.indexOf("smslocatorstart")&&(c=b.findElement("[recnum]"),document.fire("w2gi:smsLocation",{recnum:c&&c.getAttribute("recnum")}));ace.util.alertExternal(b.element());break}e=b.element().readAttribute("onclick");if(void 0==e||null==e||""==e)b.element().readAttribute("target"),
"http"==c.substr(0,4)&&window.open(c)}}}.bind(this));this.highlight&&(a.observe("mouseover",function(a){a.stop();(a=a.element().readAttribute("recnum"))&&this._markerOver(a)}.bind(this)),a.observe("mouseout",function(a){a.stop();this._markerOver()}.bind(this)));var c=$$(".sortorder");0<c.length&&c.each(function(a){(a=a.select("select")[0])&&"select"==a.tagName.toLowerCase()&&Event.observe(a,"change",function(a){var b=$F(a.target),a=a.target.options[a.target.selectedIndex].readAttribute("field_type");
ace.table.sortCurrRecords(b,a||"",this.locator.panelID);b=0;SlippyMap.locator.proximitySearch.centerPoint&&(b=SlippyMap.locator.proximitySearch.centerPoint.clone());SlippyMap.locator.smap.clear();this.update(b)}.bind(this))}.bind(this))},_markerClick:function(a,c){this.smap.locator.proximitySearch.dragStartCenter=null;if(a&&a.popup&&a.popup.visible()){if(c){var b=$(a.popup.id).select(".tab_content").invoke("hasClassName","activetabcontent").indexOf(!0),b=$(a.popup.id).select(".tab_label")[b].innerHTML;
if(c!==b)return!1}document.fire("w2gi:popupclose",{data:a.popup});return!1}for(i in this.layer.markers)if((b=this.layer.markers[i])&&b.icon)b.icon.imageDiv.style.zIndex=b.recnum==a.marker.recnum?4500:3500;this._clearPopups();this._addBubbleData(a.data);b=a.createPopup();b.recnum=a.data.recnum;b.bubbleSize=a.data.icon.bubbleSize;b.bubbleMargin=a.data.icon.bubbleMargin;b.bubbleOffset=a.data.icon.bubbleOffset;this.smap.map.addPopup(b,!0);this.smap.map.events.triggerEvent("popupopen",b);this.smap.map.adjustForBubble(a.marker.lonlat,
b.bubbleSize,b.bubbleMargin,b.bubbleOffset);return!0},_markerOver:function(a){var c=this.smap.locator.panel.down();ace.table.highlightRow(c,a,this.locator.panelID);if(a){if((markerOld=this.getPOIMarker(a))&&!markerOld.highlighted){var c=ace.table.getRecord(a,this.locator.panelID),b=this._createFeature(c,"alt_icon"),a=b.createMarker();a.recnum=c.RECNUM;a.highlighted=!0;this.highlight&&this._bindMarkerOver(a);this._bindMarkerClick(a,b);this.layer.removeMarker(markerOld);this.layer.addMarker(a);this.highlightEffect&&
this.highlightEffect(a.events.element)}}else if(a=this.layer.markers.find(function(a){return!0==a.highlighted}))c=ace.table.getRecord(a.recnum,this.locator.panelID),this.layer.removeMarker(a),this.addPOIMarker(c,!1,!1)},_addBubbleData:function(a){var c=ace.table.getRecord(a.recnum,this.locator.panelID),b=ace.table.getReviewRecord(a.clientkey,this.locator.panelID),d=ace.table.getSocialRecord(a.clientkey,this.locator.panelID),e=ace.table.getEventRecord(a.clientkey,this.locator.panelID);this._setBubbleCountry(a.bubbleID,
c);var c=ace.template.getTemplate(a.bubbleID,c),f=c.style,j=ace.util.select(c,"bubble_events"),h=ace.util.select(c,"bubble_reviews"),k=ace.util.select(c,"bubble_social");if(e&&0<e.length&&0<j.length){var g=ace.template.getTemplate("event_template");g&&(e="table"==g.tagName.toLowerCase()?ace.template.getTableTemplate(g,e):ace.template.getDivTemplate(g,e),j[0].update(e).show())}if(d&&(0<d.length&&0<k.length)&&(g=ace.template.getTemplate("social_template")))e="table"==g.tagName.toLowerCase()?ace.template.getTableTemplate(g,
d):ace.template.getDivTemplate(g,d),k[0].update(e).show();if(b&&(0<b.length&&0<h.length)&&(g=ace.template.getTemplate("review_template")))e="table"==g.tagName.toLowerCase()?ace.template.getTableTemplate(g,b):ace.template.getDivTemplate(g,b),h[0].update(e).show();a.popupContentHTML=c.innerHTML;a.popupSize=new OpenLayers.Size(f.width||0,f.height||0);a.icon.bubbleSize=a.popupSize;a.icon.bubbleMargin=new OpenLayers.Bounds(f.marginLeft||0,f.marginBottom||0,f.marginRight||0,f.marginTop||0);a.icon.bubbleOffset=
new OpenLayers.Pixel(c.readAttribute("offsetx")||0,c.readAttribute("offsety")||0)},_setBubbleCountry:function(a,c){var b=ace.template.templates[a].select("#bubble_country")[0];if(b&&b.options)for(var d=0;d<b.options.length;d++)b.options[d].value==c.COUNTRY?$(b.options[d]).setAttribute("selected","selected"):$(b.options[d]).removeAttribute("selected")},_clearPopups:function(){for(recnum in this.features){var a=this.features[recnum];if(a.popup){a.popup.destroy();a.popup=null;break}}},_createFeature:function(a,
c){var b=new OpenLayers.LonLat(a.LONGITUDE,a.LATITUDE),d=this._getFeatureData(a,c);return new OpenLayers.Feature(this.layer,b,d)},_getFeatureData:function(a,c){var b=ace.template.getIconTemplate(c||a.ICON||"default",a),d={};d.recnum=a.RECNUM;d.clientkey=a.CLIENTKEY;d.icon=new OpenLayers.Icon.IconFromTemplate(b);d.bubbleID=b.readAttribute("bubbleid");return d},_bindMarkerOver:function(a){a.events.register("mouseover",this,function(c){OpenLayers.Event.stop(c);this._markerOver(a.recnum)});a.events.register("mouseout",
this,function(a){OpenLayers.Event.stop(a);this._markerOver()})},_bindMarkerClick:function(a,c,b){a.events.register("click",this,function(a){OpenLayers.Event.stop(a);this._markerClick(c)&&document.fire("w2gi:track",{action:"clickondealer-map",value:b})});a.events.register("touchend",this,function(a){OpenLayers.Event.stop(a);this._markerClick(c)&&document.fire("w2gi:track",{action:"clickondealer-map",value:b})})}});
SlippyMap.Layer.RouteVectorLayer=Class.create(SlippyMap.Layer,{initialize:function(a,c){this.locator=a.locator;this.layer=new OpenLayers.Layer.Vector(c,{projection:new OpenLayers.Projection("EPSG:4326")});a.map.addLayer(this.layer);SlippyMap.Layer.prototype.initialize.apply(this,arguments)},destroy:function(){SlippyMap.Layer.prototype.destroy.apply(this,arguments)},clear:function(){this.layer.destroyFeatures()},addRoute:function(){this.layer.projection.toString()!=this.layer.map.baseLayer.projection.toString()&&
(this.layer.projection=new OpenLayers.Projection(this.layer.map.baseLayer.projection.toString()));var a={strokeColor:"blue",strokeOpacity:1,strokeWidth:5,pointRadius:6,pointerEvents:"visiblePainted"};Object.extend(a,this.layer.map.routeStyle||{});var c=this._getPointList(),a=new OpenLayers.Feature.Vector(new OpenLayers.Geometry.LineString(c),null,a);this.layer.addFeatures([a])},_getPointList:function(){for(var a=ace.table.data[this.locator.panelID].records.pluck("SEGMENT_GEOMETRY"),c=[],b=0,d=a.length;b<
d;b++)if(a[b]&&!(0>=a[b].length))for(var e=a[b].substring(11,a[b].length-1).split(","),f=0,j=e.length;f<j;f++){var h=e[f].split(" ");myPoint=new OpenLayers.Geometry.Point(h[0],h[1]);"EPSG:900913"==this.layer.projection.toString()&&myPoint.transform(new OpenLayers.Projection("EPSG:4326"),this.layer.projection);c.push(myPoint)}return c}});
SlippyMap.Layer.RouteImageLayer=Class.create(SlippyMap.Layer,{initialize:function(a,c){this.layer=new OpenLayers.Layer.Markers(c);a.map.addLayer(this.layer);SlippyMap.Layer.prototype.initialize.apply(this,arguments);this.smap.map.events.register("zoomend",this,this._zoomend);this.smap.map.events.register("moveend",this,this._moveend)},destroy:function(){this.smap.map.events.unregister("zoomend",this,this._zoomend);this.smap.map.events.unregister("moveend",this,this._moveend);SlippyMap.Layer.prototype.destroy.apply(this,
arguments)},clear:function(){this.layer.clearMarkers()},addRoute:function(){var a=this._getImageParams();ace.request(a,this._processResponse.bind(this),{formdataID:"get_route_image",onHistory:!1})},_getFullRouteMarkers:function(){return this.layer.markers.findAll(function(a){return a.isFullImage})},_processResponse:function(a){this.layer.clearMarkers();a=ace.xml.parse(a);a=this._getRouteImage(a[0]);a.isFullImage=this._viewContainsRoute();this.layer.addMarker(a);return!0},_getRouteImage:function(a){var c=
new OpenLayers.Size(a.WIDTH,a.HEIGHT),c=new OpenLayers.Icon(a.URL,c,null,function(){return new OpenLayers.Pixel(0,0)}),a=new OpenLayers.LonLat(a.OFFSET_X,a.MAX_Y);return new OpenLayers.Marker(a,c)},_getImageParams:function(){var a=this.smap.map.getExtent(),c=this.smap.map.getSize().w,b=this.smap.map.getSize().h;"EPSG:900913"==this.smap.map.baseLayer.projection.toString()&&a.transform(this.smap.map.baseLayer.projection,new OpenLayers.Projection("EPSG:4326"));return{routeid:0,bounds:a.left+","+a.bottom+
","+a.right+","+a.top,height:b,width:c}},_zoomend:function(){0>=this.layer.markers.length||this._routeIntersectsView()&&this.addRoute()},_moveend:function(){0>=this.layer.markers.length||0<this._getFullRouteMarkers().length||this._routeIntersectsView()&&this.addRoute()},_routeIntersectsView:function(){return this.smap.map.getExtent().intersectsBounds(this.smap.locator.directionsSearch.bounds)},_viewContainsRoute:function(){return this.smap.map.getExtent().containsBounds(this.smap.locator.directionsSearch.bounds)}});
SlippyMap.Layer.RouteMarkerLayer=Class.create(SlippyMap.Layer,{initialize:function(a,c){this.layer=new OpenLayers.Layer.Markers(c,{projection:new OpenLayers.Projection("EPSG:4326")});a.map.addLayer(this.layer);SlippyMap.Layer.prototype.initialize.apply(this,arguments)},destroy:function(){SlippyMap.Layer.prototype.destroy.apply(this,arguments)},clear:function(){this.layer.clearMarkers()},addEndMarkers:function(a){a.each(function(c,b){var d=null,d=0>=b?ace.template.getTemplate("ddstarticon",c):ace.template.getTemplate("ddendicon",
c);null==d&&(d=ace.template.getIconTemplate("default",c));var d=new OpenLayers.Icon.IconFromTemplate(d),e=new OpenLayers.LonLat(c.LONGITUDE,c.LATITUDE),d=new OpenLayers.Marker.DragabbleMarker(e,d,this.smap.locator.disableDynamicRoutes);"EPSG:900913"==this.smap.map.baseLayer.projection.toString()&&d.setSphericalMercator(!0);e=0>=b?a.last():a.first();this.smap.locator.disableDynamicRoutes||d.events.register("mouseup",d,this._mouseUp.bind(this,d,b,e));d.events.register("touchend",d,this._mouseUp.bind(this,
d,b,e));this.layer.addMarker(d)}.bind(this))},_mouseUp:function(a,c,b){a.reverseGeocode(function(a){var e=new OpenLayers.LonLat(a.lonlat.lon,a.lonlat.lat);this.smap.locator.directionsSearch.markerSearch(a,c,b);a.moveToLonLat();document.fire("w2gi:track",{action:"routemarkerdrag",value:e.toShortString()})}.bind(this),{routeDrag:!0})}});
